### Инструкция по установке почтового сервера отказоустойчивая архитектура (ОС Astra Linux Orel 1.7.4)
Ссылка на установку и настройку от Р7 

https://support.r7-office.ru/corporate-server2024/install-r7server/single/otkazoustojchivaja-arhitektura-korporativnyj-server-2024-pochtovyj-server-na-astra-linux-1-7-4/

[https://support.r7-office.ru/community_server/api/](https://support.r7-office.ru/category/corporate-server2024/api-ks-tutorials/)

Изменение доменных имен и обновление ssl-сертификатов модулей Корпоративного сервера 2024

https://support.r7-office.ru/corporate-server2024/settings_cs-r7disk/izmenenie-domennyh-imen-modulej-korporativnogo-servera-2024/

Содержание.

1.	Подготовка к установке
    - подготовка ПО Астра Линукс (настройка сети, установка обновлений, установка дополнительных программ) на сервере 1
    - подготовка ПО Астра Линукс (настройка сети, установка обновлений, установка дополнительных программ) на сервере 2
2. Установка GlusterFS и базы данных PostgreSQL<br>
    2.1 Установка GlusterFS и базы данных PostgreSQL на сервере 1<br> 
    2.2 Установка GlusterFS и базы данных PostgreSQL на сервере 2<br>
    2.3 Создание томов<br>
3. Установка и настройка БД<br>
    3.1 Настройка БД на сервере 1<br>
    3.2 Настройка БД на сервере 2<br>
    3.3 Настройка репликации БД<br>
4. Установка Корпоративного сервера<br> 
    4.1 Установка Корпоративного сервера на сервере 2<br>
    4.2 Установка Корпоративного сервера на сервере 1<br>
    4.3 настройка Nginx и Сервер документов<br>
    4.4 настройка подключения почтового сервера (*опционально)<br>
    4.5 Управление переключением БД при неработоспособности первого сервера (скрипт управления)<br>
5.	Настройка LDAP
      - подключение по LDAP на почтовом сервере
      - миграция пользователей из AD
      - создание пользователя и почтового ящика
      - проверка работы почтового адреса (хождение внутренней почты) на самом сервере Р7
      - настройка DNS записей на сервере ALDPRO (настройка почтовых протоколов)   
6.	Настройка API для работы с почтовым сервером
      - предворительная установка пакетов
      - установка htpasswd на сервер
      - установка и настройка модуля dovecot и postfix
      - настройка модуля quota для dovecot с настройкой подключения через LDAP
8.	Настройка Autodiscover для корпоративного почтового сервера Р7
9.	Настройка брандмауэра(firewalld)
10.	Резервное копирование и восстановление
11.	Установка и настройка Органайзера

#### Системные требования.
```bash
Поддерживается только 64-битная архитектура 
2 Виртуальные машины
Для хранения данных glusterfs
ТХ Машин, для тестирования, возможно использовать:
- от 4 CPU;
- от 8Гб RAM;
- от 50Гб свободного пространства на диске;
Более конкретные данные рассчитываются по обращению в ТП
Отключение или перевод selinux в режим permissive для корректной работы сервисов
```
>[!WARNING]
>Минимальные системные требования рассчитаны при одновременной работе до 300 пользователей

В архитектуре используются следующие компоненты и входят в состав стандартной установки Корпоративного сервера 2024:
```bash
PostgreSQL 11
RabbitMQ-server 3.13.7
Redis server 7.2.7
glusterfs 5.5
```
****
#### 1. Подготовка к установке
##### Подготовка ПО Астра Линукс (настройка сети, установка обновлений, установка дополнительных программ) на сервере 1   

- Скачаваем образ **1.7.4-24.04.2023_14.23.iso**
- Скачайте архив Корпоративный сервер 2024 для установки **Оффлайн установкаТекущая версия: 2025.3.12.15877**
- Скачайте архив `cddisk.zip` который содержит пакеты для корпоративного сервера 2024
- Подготовьте сертификаты

>[!WARNING]
>Для установки потребуется wildcard сертификат, содержащий полную цепочку (fullchain)

Например:
```cmd
—-BEGIN CERTIFICATE——
(Your Primary SSL certificate: your_domain_name.crt)
——END CERTIFICATE——
——BEGIN CERTIFICATE——
(Your Intermediate certificate: DigiCertCA.crt)
——END CERTIFICATE——
——BEGIN CERTIFICATE——
(Your Root certificate: TrustedRoot.crt)
——END CERTIFICATE——
```
>Где:
> - Основной Certificate — your_domain_name.crt
> - Промежуточный Certificate — DigiCertCA.crt
> - Корневой Certificate — TrustedRoot.crt

**Ссылки:**
- https://support.r7-office.ru/corporate-server2024/install-r7server/single/otkazoustojchivaja-arhitektura-korporativnyj-server-2024-pochtovyj-server-na-astra-linux-1-7-4/
- https://r7-office.ru/downloadserver#retail
- https://nct.r7-office.ru/link/549705e3-5e21-49f1-afc4-57c88ecae674 

Для корректной установки почтового сервера весь архив и сертификаты поместить в директории `/mnt` и распоковать их

Распакуйте архивы CDinstall_2.0.2024.14752_Astra_1.7.4_offline.zip и cddisk.zip
```bash
# cd /mnt
# unzip CDinstall_2.0.2024.14752_Astra_1.7.4_offline.zip
# unzip cddisk.zip
```
Перед установкой почтового сервера, скопируйте crt и key файлы в папку /mnt/CDDiskPack/CDinstall_Astra_1.7.4/sslcert

Устанавливаем виртуальную машину ОС Астра 1.7.4 из образа
```bash
1.7.4-24.04.2023_14.23.iso
```
> При установке операционной системы выберите пункты (во избежание сообщений об отсутствующих зависимостях)
> - **«Средства работы с интернет»** <br>
> - **«Консольные утилиты»** <br>
> - **«Средства удаленного подключения SSH»** 
 
> [!WARNING]
> Для упрощения в работе временно даём разрешение на подключению по ssh для суперадмина root

Открываем терминал меняем пароль на root и даём разрешение на подключение в файле `/etc/ssh/sshd_config`
```bash
$ sudo -i
# sed -i 's/^#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
```
#### Раскомментировать PermitRootLogin и установить значение yes:
```bash
# sed -i 's/^#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
```
##### Перезапустить SSH службу для применения изменений:
######  Для системы с systemd (большинство современных дистрибутивов)
```bash
# systemctl restart sshd
```
##### Проверить, что изменения применились:
```bash
# sshd -T | grep permitrootlogin
```
#### Настраиваем сеть
Настраиваем ``FQDN`` имя первого почтового сервера:
```bash
hostnamectl set-hostname mx1.r16.rosreestr.ru
```
Отключаем ipv6 на всех интерфейсах кроме lo.(не обязательно!) 
> [!TIP]
>Отключение IPv6 настройкой параметров ядра сделано в ОС Astra Linux по умолчанию (см. выше файл /etc/sysctl.d/999-astra.conf), однако при наличии загруженного модуля ядра IPv6 служба NetworkManager по умолчанию сама назначает сетевым интерфейсам адреса IPv6. 
>Независимо от используемой аппаратной платформы для успешной работы серверов (реплик) FreeIPA сетевой интерфейс обратной петли (loopback, lo) должен иметь адрес IPv6.

```bash
nano  /etc/sysctl.d/999-astra.conf
# Astra sysctl config

kernel.sysrq = 0
fs.suid_dumpable = 0
kernel.randomize_va_space = 2
net.ipv4.tcp_timestamps = 0
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 0
```
Применяем настройки
```bash
sysctl --system
или можно так
sysctl -p
```
Отключаем NetworkManager.

Откючаем и забываем, на серверах не должно быть динамического адреса.
```bash
sudo systemctl status NetworkManager //проверяем статус службы NetworkManager
sudo systemctl stop NetworkManager //останавливает службу
sudo systemctl disable NetworkManager //удаляет её из автозагрузки
sudo systemctl mask NetworkManager //останавливает активность службы
astra-noautonet-control disable //контрольный выстрел
```

Настраиваем статический адрес службы ``networking.service`` 

вводим команду: ``nano /etc/network/interfaces``
```bash
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

auto eth0
allow-hotplug eth0
iface eth0 inet static
address 10.113.25.18
netmask 255.255.255.0
gateway 10.113.25.11
```
$${\color{#FF8800}reboot}$$

После перезагрузки проверяем
```bash
root@mx1:~# hostname && hostname -s && hostname -f && hostname -d
mx1.r16.rosreestr.ru
mx1
mx1.r16.rosreestr.ru
r16.rosreestr.ru
root@mx1:~#
```

Открываем репозитории  nano /etc/apt/sources.list

<img width="1278" height="210" alt="image" src="https://github.com/user-attachments/assets/f4b501e2-998f-46d2-9b2f-3dc0dac47e02" />

```bash
# sed -i '/^deb.*cdrom/s/^deb/#deb/' /etc/apt/sources.list
# sed -i '/repository-main/s/^#//' /etc/apt/sources.list
# sed -i '/repository-base/s/^#//' /etc/apt/sources.list
# sed -i '/repository-extended/s/^#//' /etc/apt/sources.list
```

Теперь обновим и установим необходимые для дальнейшей работы пакеты
```bash
# apt update
# apt install open-vm-tools
# apt install dnsutils wget curl
# apt install cabextract
```
Добавим и запустить службу синхронизации времени chrony в автозапуск.
>[!Note]
>Серверная служба chronyd (пакет chrony) Может обеспечивать работу ОС в режиме как сервера точного времени, так и клиента. Является штатной службой времени для использования с контроллерами домена FreeIPA.

```bash
# apt install chrony
# systemctl start chrony
# systemctl enable chrony
```
Добавим Российские NTP сервера и можно указать разрешённую сеть для клиентов.
Вводим ``nano /etc/chrony/chrony.conf`` и добавляем эти строки
```bash
server 0.ru.pool.ntp.org iburst
server 1.ru.pool.ntp.org iburst
server 2.ru.pool.ntp.org iburst
server 3.ru.pool.ntp.org iburst
```

<img width="1276" height="942" alt="image" src="https://github.com/user-attachments/assets/8d7c2ea7-af52-4a7b-83fd-b5b52720c2ec" />

После настройки сервера нужно перезапустить службу: ``# systemctl restart chrony``

Проверим источники времени:``# chronyc -N sources``

Проверим порт. Сервер времени chrony, также как и другие NTP сервера слушает порт udp 123: ``sudo ss -ulpn | grep chronyd``

Можем посмотреть количество активных и не активных источников: ``sudo chronyc activity``

Сделаем перезагрузку и убедимся, что служба запускается автоматически.


Подготовка к установке завершена.

**$${\color{#FF8800}REBOOT}$$**

После перезагрузки ещё раз убедимся что всё в порядке, проверяем
```bash
root@mx1:~# hostname && hostname -s && hostname -f && hostname -d
должно показать это
mx1.r16.rosreestr.ru
mx1
mx1.r16.rosreestr.ru
r16.rosreestr.ru
root@mx1:~#
```
>[!Note]
>Теперь все эти настройки повторить на втором почтовом сервере!
>##### Подготовка ПО Астра Линукс (настройка сети, установка обновлений, установка дополнительных программ) на сервере 2

#### 2. Установка GlusterFS и базы данных PostgreSQL

**Схема взаимодействия между почтовыми серверами**

<img width="768" height="426" alt="image" src="https://github.com/user-attachments/assets/96c1e639-fc51-4122-834c-b6fae3ccce34" />

### 2.1 установка GlusterFS и базы данных PostgreSQL $${\color{red}На}$$ $${\color{red}сервере}$$ $${\color{red}№1}$$
##### Установка и настройка glusterfs
Добавьте запись в /etc/hosts например так:
```bash
127.0.0.1       localhost
10.12.113.18    gluster1 #ip адрес первого почтового сервера
10.12.113.19    gluster2 #ip адрес второго почтового сервера
```
>[!Warning]
> - Рекомендуется использовать запись 127.0.0.1 localhost как стандартную и без использования имени сервера, так как в дальнейшем будут добавлены другие записи для работы почтового сервера.
> - Для корректной установки корпоративного сервера требуется наличие перевода строки в конце файла /etc/hosts.
>- Без использования почтового сервера возможно задать любое имя сервера.

**пример файла hosts**
```bash
127.0.0.1       localhost
10.179.15.18     mx10.rosreestr.ru        mx10
10.179.15.19     mx20.rosreestr.ru        mx20
10.12.14.7       доменное имя сервера репозиториев     имяКомпьютера   #доменное имя сервера репозиториев по короткому имени
10.12.14.2       доменное имя АЛДПРО                   имяКомпьютера   #доменное имя АЛДПРО по короткому имени

# The following lines are desirable for IPv6 capable hosts
#::1     localhost ip6-localhost ip6-loopback
#ff02::1 ip6-allnodes
#ff02::2 ip6-allrouters

10.179.15.18 gluster1
10.179.15.19 gluster2
10.12.14.7    доменное имя сервера репозиториев
10.12.14.2    доменное имя АЛДПРО
```
### 2.2 установка GlusterFS и базы данных PostgreSQL $${\color{red}На}$$ $${\color{red}сервере}$$ $${\color{red}№2}$$

Добавьте запись в /etc/hosts:
```bash
127.0.0.1       localhost
first_ip_address  gluster1 #ip адрес первого почтового сервера
second_ip_address gluster2 #ip адрес второго почтового сервера
```
>[!Warning]
> - Рекомендуется использовать запись 127.0.0.1 localhost как стандартную и без использования имени сервера, так как в дальнейшем будут добавлены другие записи для работы почтового сервера.
> - Для корректной установки корпоративного сервера требуется наличие перевода строки в конце файла /etc/hosts.
>- Без использования почтового сервера возможно задать любое имя сервера.

##### На всех нодах $${\color{red}НА}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№1}$$ и $${\color{red}НА}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№2}$$ установить, запустить и добавить в автозагрузку
```cmd
apt install -y glusterfs-server
systemctl start glusterd.service
systemctl enable glusterd.service
```
Не имеет значения, какой из узлов вы будете использовать, но в следующем примере команда запускается на gluster1:
```cmd
gluster peer probe gluster2
```
Фактически эта команда сообщает gluster1 доверять gluster2 и регистрирует его как часть пула хранения данных.

Если зондирование пройдет успешно, вы получите следующий вывод:
```cmd
peer probe: success
```
Вы можете проверить связь узлов в любое время путем запуска команды:
```cmd
gluster peer status
```
Если вы запустите эту команду из gluster2, вы увидите следующий вывод:
```cmd
Number of Peers: 1
Hostname: gluster2
Uuid: 7ecfa2d1-3394-4f15-a1f5-bba484f2bbef
State: Peer in Cluster (Connected)
```
<img width="1107" height="115" alt="image" src="https://github.com/user-attachments/assets/0a5238c3-111f-45fd-b9e0-e235da19704d" />

> [!IMPORTANT]
>- Рекомендуется на время установки/настройки отключить firewalld.

### 2.3 Создание томов
>[!Warning]
>Выполняется **$${\color{red}НА}$$ $${\color{red}ПЕРВОМ}$$ $${\color{red}СЕРВЕРЕ №1}$$**

Для создания тома вы будете использовать команду gluster volume create с таким общим синтаксисом:

##### и для почтового сервера
```cmd
sudo gluster volume create mail_volume replica 2 gluster{1,2}:/mail_volume force
```
##### для корпоративного сервера
```cmd
sudo gluster volume create cddisk-filestorage replica 2 gluster{1,2}:/cddisk-filestorage force
sudo gluster volume create cddisk-searchindex replica 2 gluster{1,2}:/cddisk-searchindex force
sudo gluster volume create ds-data replica 2 gluster{1,2}:/ds-data force
sudo gluster volume create ds-cache replica 2 gluster{1,2}:/ds-cache force
```
***
***Если том был создан успешно, вы увидите следующий вывод:***
```cmd
volume create: mail_volume: success: please start the volume to access data
```
***
На этом этапе ваш том создан, но еще не активирован. Вы можете запустить том и сделать его доступным для использования путем выполнения следующей команды с любого сервера Gluster:

##### для почтового сервера
```cmd
sudo gluster volume start mail_volume
```
##### для корпоративного сервера
```cmd
sudo gluster volume start cddisk-filestorage
sudo gluster volume start cddisk-searchindex
sudo gluster volume start ds-data
sudo gluster volume start ds-cache
```
***
***Вы получите следующий вывод, если том запущен корректно:***
```cmd
volume start: mail_volume: success
volume start: cddisk-filestorage: success
volume start: cddisk-searchindex: success
volume start: ds-data: success
volume start: ds-cache: success
```
***
Затем проверьте, находится ли том в сети. Запустите следующую команду с любого из ваших узлов:
```cmd
sudo gluster volume status
```
***В результате вы увидите вывод, аналогичный данному:***
***
```cmd
Status of volume: mail
Gluster process TCP Port RDMA Port Online Pid
------------------------------------------------------------------------------
Brick gluster1:/mail 49152 0 Y 4495
Brick gluster2:/mail 49152 0 Y 20192
Self-heal Daemon on localhost N/A N/A Y 4518
Self-heal Daemon on gluster2 N/A N/A Y 20215
Task Status of Volume mail_volume
------------------------------------------------------------------------------
There are no active volume tasks
```
***
<img width="1277" height="934" alt="image" src="https://github.com/user-attachments/assets/1739f52c-664c-418e-9606-aa6af6043454" />

Создайте каталог и смонтируйте
>[!Warning]
>Инструкция ниже выполняется на всех нодах **$${\color{red}НА}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№1}$$ и $${\color{red}НА}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№2}$$**

##### для почтового сервера
```cmd
mkdir /mail
```
##### для корпоративного сервера
```cmd
mkdir -p /var/r7-office/filestorage
mkdir -p /var/r7-office/searchindex
mkdir -p /var/www/r7-office/Data
mkdir -p /var/lib/r7-office/documentserver/App_Data/cache
```
##### для почтового сервера
```cmd
mount.glusterfs localhost:/mail_volume /mail
```
##### для корпоративного сервера
```cmd
mount.glusterfs localhost:/cddisk-filestorage /var/r7-office/filestorage
mount.glusterfs localhost:/cddisk-searchindex /var/r7-office/searchindex
mount.glusterfs localhost:/ds-data /var/www/r7-office/Data
mount.glusterfs localhost:/ds-cache /var/lib/r7-office/documentserver/App_Data/cache
```
Добавьте в автозагрузку:

##### для почтового сервера 
```cmd
{
echo 'localhost:/mail_volume /mail glusterfs defaults,_netdev,backupvolfile-server=localhost 0 0'
echo 'localhost:/cddisk-filestorage /var/r7-office/filestorage glusterfs defaults,_netdev,backupvolfile-server=localhost 0 0'
echo 'localhost:/cddisk-searchindex /var/r7-office/searchindex glusterfs defaults,_netdev,backupvolfile-server=localhost 0 0'
echo 'localhost:/ds-data /var/www/r7-office/Data glusterfs defaults,_netdev,backupvolfile-server=localhost 0 0'
echo 'localhost:/ds-cache /var/lib/r7-office/documentserver/App_Data/cache glusterfs defaults,_netdev,backupvolfile-server=localhost 0 0'
} | sudo tee -a /etc/fstab
```
<img width="1106" height="323" alt="image" src="https://github.com/user-attachments/assets/b0f38449-bea3-490b-aa51-225c57917db5" />

Добавьте задание для перезапуска glusterfs, в случае перезагрузки или выключения питания:

>[!Warning]
>Инструкция ниже выполняется на всех нодах **$${\color{red}НА}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№1}$$ и $${\color{red}НА}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№2}$$**

После перезагрузки сервера, могут наблюдаться проблемы с синхронизацией glusterfs. Поэтому данный метод решает эту проблему:
```cmd
echo "@reboot sleep 30 && systemctl restart glusterd.service" | crontab -
```
Проверка монтирования:
```cmd
df -h
mount -a
```
Если всё парвильно сделали должно быть так:

<img width="1111" height="248" alt="image" src="https://github.com/user-attachments/assets/6ed48387-88bb-4739-a612-ef6404d35c84" />

Проверьте корректность синхронизации каталогов между серверами, создавая тестовые файлы или каталоги в монтированных каталогах.

При настройке разрешенных портов рекомендуется проверить все задействованные порты на двух серверах:
```cmd
ss -tulnp | grep gluster
```
>[!Note]
> - Для применения параметров выполните перезапуск серверов.

**На этом этапе два ваших сервера взаимодействуют и готовы к созданию томов хранения друг с другом**

#### 3. Установка и настройка БД.
Установите следующие пакеты на оба сервера:
```cmd
sudo apt update && sudo apt install postgresql -y
```
##### БД
>[!Warning]
> - Инструкция ниже выполняется на всех нодах **$${\color{red}НА}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№1}$$ и $${\color{red}НА}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№2}$$**

Отредактируйте postgresql.conf:
```cmd
sudo nano /etc/postgresql/11/main/postgresql.conf
```
>[!Warning]
> - В зависимости от версии установленной postgresql сервера, путь к конфигурационному файлу может отличаться.

Приведите параметры к виду:
```cmd
listen_addresses = 'localhost,10.179.15.18,10.179.15.19' # what IP address(es) to listen on;
port = 5432
```
- Где: localhost,10.179.15.18,10.179.15.19 — адреса, которые слушает сервис; 5432 — порт, который сервис прослушивает.

В файле postgresql.conf разрешите логическую репликацию. Для этого отредактируйте /etc/postgresql/11/main/postgresql.conf:
```cmd
listen_addresses = 'localhost,ip_srv,ip_srv2'       # Слушать на адресах
port = 5432                         # Задать порт БД
wal_level = replica             # Включить репликацию
archive_mode = on               # Включить архивирование WAL
archive_command = 'cp %p /var/lib/postgresql/11/main/archive/%f'   # Команда для архивирования WAL, в зависимости от версии установленной postgresql сервера, путь к файлу может отличаться
max_wal_senders = 5            # Максимальное количество одновременных подключений репликации
max_replication_slots = 5          # Количество слотов для репликации
hot_standby = on                # Разрешить подключения в режиме hot standby
hot_standby_feedback = on        # Определяет, будет или нет сервер slave сообщать мастеру о запросах, которые он выполняет.
```
> - Где: ip_srv1, ip_srv2 — адреса внутренней сети первого и второго почтового сервера.

Настройте аутентификацию пользователей в базе данных. Приведите к следующему виду файл ``/etc/postgresql/11/main/pg_hba.conf``:

##### Разрешить локальные подключения для всех пользователей
```cmd
# "local" is for Unix domain socket connections only
local   all             all                              trust
# IPv4 local connections:
host    all             all             127.0.0.1/32     trust
host    all             all             ip_srv1/32       trust
host    all             all             ip_srv2/32       trust
```
> - Вместо ``ip_srv1/32 и ip_srv2/32`` укажите IP-адрес двух серверов. Режим trust необходим для установки Корпоративного сервера.

И добавьте строки в конце для возможности репликации БД:

##### Разрешить репликацию с обоих серверов для пользователя replication_user
```cmd
host    replication     replication_user        ip_srv1/32    md5
host    replication     replication_user        ip_srv2/32    md5
```
> - Где: ``ip_another_srv/32`` — адрес первого или второго почтового сервера, в зависимости от сервера, где производится настройка.

Выполните перезапуск сервиса БД:
```cmd
sudo systemctl restart postgresql
```
>[!Warning]
> - Инструкция ниже выполняется **$${\color{red}НА}$$ $${\color{red}ПЕРВОМ}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№1}$$**

После базовой настройки базы данных, создаем необходимую структуру в БД, создаем пользователей и настраиваем репликацию:
```cmd
sudo -u postgres psql
```
В консоли psql> выполните следующие команды (вместо паролей password и replication_password, cddisk и ds задайте свои пароли), подтверждая каждую нажатием 
```cmd
Enter
:
```
>[!Warning] Не рекомендуется использовать другие имена для баз данных cddisk и ds.
```cmd
CREATE USER cddisk WITH password 'cddisk';
CREATE USER ds WITH password 'ds';
CREATE DATABASE cddisk OWNER cddisk;
CREATE DATABASE ds OWNER ds;
CREATE DATABASE pagesdb OWNER cddisk;
GRANT ALL privileges ON DATABASE cddisk TO cddisk;
GRANT ALL privileges ON DATABASE ds TO ds;
GRANT ALL privileges ON DATABASE pagesdb TO cddisk;
CREATE USER replication_user WITH REPLICATION LOGIN PASSWORD 'replication_password';
GRANT CONNECT ON DATABASE cddisk TO replication_user;
GRANT CONNECT ON DATABASE ds TO replication_user;
\c cddisk
GRANT USAGE ON SCHEMA public TO replication_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO replication_user;
GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO replication_user;
\c ds
GRANT USAGE ON SCHEMA public TO replication_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO replication_user;
GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO replication_user;
Для выхода из БД
\q
```
>[!Warning]
> - Инструкция ниже выполняется **$${\color{red}НА}$$ $${\color{red}ПЕРВОМ}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№1}$$**

Создайте директорию для архива:

в зависимости от версии установленной postgresql сервера, путь к каталогу может отличаться
```cmd
sudo mkdir -p /var/lib/postgresql/11/main/archive
sudo chown -R postgres:postgres /var/lib/postgresql/11/main/archive
sudo chmod -R 750 /var/lib/postgresql/11/main/archive
```
>[!Warning]
> - Инструкция ниже выполняется **$${\color{red}НА}$$ $${\color{red}ПЕРВОМ}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№1}$$**

Перезагрузите службу PostgreSQL для применения изменений:
```cmd
systemctl restart postgresql*
```
##### Настройка репликации БД
>[!Warning]
> - Инструкция ниже выполняется **$${\color{red}НА}$$ $${\color{red}ВТОРОМ}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№2}$$**

Удалите существующую директорию данных:

в зависимости от версии установленной postgresql сервера, путь к каталогу может отличаться
```cmd
rm -rf /var/lib/postgresql/11/main
```
Создайте базовую резервную копию с мастера:

в зависимости от версии установленной postgresql сервера, путь pgdata=/var/lib/postgresql/11/main может отличаться
```cmd
su - postgres -c "pg_basebackup --host=ip_srv1 --username=replication_user --pgdata=/var/lib/postgresql/11/main --wal-method=stream --write-recovery-conf"
```
- Где: ip_srv1 — адрес внутренней сети первого сервера, с master БД.

Например:
```cmd
su - postgres -c "pg_basebackup --host=10.179.15.18 --username=replication_user --pgdata=/var/lib/postgresql/11/main --wal-method=stream --write-recovery-conf"
```
Запросит пароль, введите: replication_password

Перезапустите сервис и проверьте его статус:
```cmd
systemctl restart postgresql*
systemctl status postgresql*
```
****
#### 4. Установка Корпоративного сервера.

Выполнение установки по инструкции Установка Корпоративный сервер 2024 на ОС Астра Линукс https://support.r7-office.ru/corporate-server2024/install-r7server/single/ustanovka-r7-disk/.

##### Предварительная подготовка
>[!Warning]
> - Установка выполняется сначала **$${\color{red}НА}$$ $${\color{red}ВТОРОМ}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№2}$$**

Перейдите и скачайте дистрибутив на сервер № 2.

>[!NOTE]
> - Для корректной установки, разместите архив в директории, отличной от /root, например в /mnt или /tmp.
> - Нашу настройку двухнодовой архитектуры необходимо начать с установки на втором сервере, чтобы избежать последующих ошибок с серверами.

Перейдите в каталог:
```cmd
cd /mnt
```
>[!Warning]
> - Для offline установки требуется установить пакеты в систему и подключить ISO-образ установочного диска операционный системы в папку distr.

>[!TIP]
> - Скачать пакеты можно по данной ссылке https://nct.r7-office.ru/link/549705e3-5e21-49f1-afc4-57c88ecae674.

```
>[!Warning]
> - В папку ./distr положите ISO-образ установочного диска операционный системы. Файл должен быть с расширением .iso. Данный образ вы можете скачать с официального сайта производителя.

Распакуйте архивы:
```cmd
unzip CDinstall_*.zip
unzip cddisk.zip 
```
<img width="1112" height="265" alt="image" src="https://github.com/user-attachments/assets/484928c4-9421-470d-b25d-fc73f27649cc" />

Перейдите в каталог ``cd /mnt/cddisk/`` и установите пакеты:
```cmd
root@mx1:~# cd /mnt/cddisk/
root@mx1:/mnt/cddisk# ls
install.sh  repo
root@mx1:/mnt/cddisk#
root@mx1:/mnt/cddisk# chmod +x install.sh
root@mx1:/mnt/cddisk#./install.sh
```
После распаковки архивов, положите дистрибутивы в определенные папки distr и sslcert. 

**Дистрибутив 1.7.4-24.04.2023_14.23.iso в эту папку /mnt/CDDiskPack/CDinstall_Astra_1.7.4/distr#**

**Сертификаты в эту папку /mnt/CDDiskPack/CDinstall_Astra_1.7.4/sslcert#**
```cmd
root@mx1:~# ls /mnt/CDDiskPack/CDinstall_Astra_1.7.4/distr/
1.7.4-24.04.2023_14.23.iso
root@mx1:~# ls /mnt/CDDiskPack/CDinstall_Astra_1.7.4/sslcert/
 rosreestr.ru.cer    rosreestr.ru.key   'Корн Russian Trusted root.cer'  'Корн Russian Trusted sub.cer'
root@mx1:~#
```

>[!Warning]
> - Для корректной работы Корпоративного сервера 2024 обязательно требуется настройка HTTPS. Перед установкой скопируйте crt и key файлы в папку sslcert
> - Перед началам установки проверьте свои сертификаты

Проверка сертификатов и конвертирование в нужный формат 

Например, если мы имеем формат ``*.cer (rosreestr.ru.cer)`` его надо перевести в формат ``*.crt``
```cmd
openssl x509 -inform DER -in rosreestr.ru.cer -out rosreestr.ru.crt
```
Если мы имеем формат корневых сертификатов ``*.cer ('Корн Russian Trusted root.pem' и 'Корн Russian Trusted sub.pem')`` их требуется перевести в формат ``*.pem`` 
```cmd
openssl x509 -inform der -in Корн\ Russian\ Trusted\ root.cer -out Корн\ Russian\ Trusted\ root.pem
openssl x509 -inform der -in Корн\ Russian\ Trusted\ sub.cer -out Корн\ Russian\ Trusted\ sub.pem
```
Проверяем и добавляем в хранилище
```cmd
file rosreestr.ru.crt
head -5 rosreestr.ru.crt
openssl x509 -in rosreestr.ru.crt -text -noout | head -20
```
<img width="1064" height="418" alt="image" src="https://github.com/user-attachments/assets/6b146c3e-a6e6-43cd-ab51-0e58b60ba1fe" />

```cmd
cp rosreestr.ru.crt /usr/local/share/ca-certificates/
cp rosreestr.ru.key /usr/local/share/ca-certificates/
cp 'Корн Russian Trusted root.pem' /etc/ssl/certs/
cp 'Корн Russian Trusted sub.pem' /etc/ssl/certs/
update-ca-certificates -v
update-ca-certificates --fresh
```

##### 4.1 Установка Корпоративного сервера на сервере 2
>[!Warning]
> - Инструкция ниже выполняется **$${\color{red}НА}$$ $${\color{red}ВТОРОМ}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№2}$$**

Установка ``offline``

Предоставьте права на скрипт установки:
```cmd
chmod +x online_installer.sh
````
Если Offline установка
```cmd
chmod +x offline_installer.sh
```
>[!Warning]
> - Обязательно убедитесь, что все репозитории отключены, чтобы установка пакетов происходила исключительно из offline архива.
> - Для этого удалите или закомментируйте (добавив символ # в начало строки) все строки в файле /etc/apt/sources.list, а также очистите содержимое папки /etc/apt/sources.list.d.
> - Закомментируйте свой IP адрес шлюза

<img width="1116" height="572" alt="image" src="https://github.com/user-attachments/assets/2f39a0c8-6bab-44a8-8bce-6d7d251e222e" />

Проверряем
```cmd
ping 1.1.1.1
сеть не доступна 
```
После этого запустите установку:
```
./offline_installer.sh
```
**Выберите Нет, иначе произойдет удаление PostgreSQL:**

<img width="605" height="234" alt="image" src="https://github.com/user-attachments/assets/21b84d07-1bba-4d2f-9df3-026d2aa8cacf" />

**Выберите Нет:**

<img width="603" height="234" alt="image" src="https://github.com/user-attachments/assets/babd41a6-d193-4efb-865e-ad2df8cf22cd" />

**Выберите Да:**

<img width="606" height="235" alt="image" src="https://github.com/user-attachments/assets/14b9f9ff-9add-46f0-b265-f710d3b82f9d" />

**Задайте secret. Необходимо ввести секрет (Набор цифр, букв и спецсимволов. Длина от 8 символов) для защищённого доступа Р7-Диска и Сервера документов:**

<img width="603" height="234" alt="image" src="https://github.com/user-attachments/assets/04886b11-b06a-4e9e-bafa-f39f50d94394" />

**Укажите пароль к БД ds, ранее созданный в пункте 3.1 (из примера: ds):**

<img width="602" height="232" alt="image" src="https://github.com/user-attachments/assets/f8ef689b-ad72-459e-8ef8-7892c2f7a3ed" />

**Выберите Да:**

<img width="604" height="235" alt="image" src="https://github.com/user-attachments/assets/b66b095a-c625-4f78-ba34-b3f0173320f1" />

**Выберите PostgreSQL:**

<img width="403" height="277" alt="image" src="https://github.com/user-attachments/assets/d3d86bc1-3b71-40de-bd23-2d0ea4629f00" />

**Выберите Нет:**

<img width="604" height="233" alt="image" src="https://github.com/user-attachments/assets/2231193d-ff96-427e-98d9-aa01b7c7b925" />

**Укажите БД master и IP-адрес первого сервера 1 (мастер):**

<img width="600" height="231" alt="image" src="https://github.com/user-attachments/assets/b26c42b0-1d6e-4456-b5d6-af7081da67a5" />

**Укажите по умолчанию порт 5432:**

<img width="601" height="231" alt="image" src="https://github.com/user-attachments/assets/ad085a8d-bdbd-4f96-86ef-989c62a4e467" />


**Укажите БД cddisk из пункта 3.1 (из примера: cddisk):**

<img width="608" height="235" alt="image" src="https://github.com/user-attachments/assets/1fb3cb5e-c2b3-4fa7-b507-d847e7dd59bc" />


**Укажите системного пользователя postgres:**

<img width="602" height="229" alt="image" src="https://github.com/user-attachments/assets/b1b9a5aa-5d40-4cbd-835e-c4f5f7bb79bc" />

**Укажите пользователя cddisk:**

<img width="600" height="229" alt="image" src="https://github.com/user-attachments/assets/0a899566-6c6b-4322-979d-9814afa15755" />

**Укажите пароль к БД cddisk из пункта 3.1 (из примера: cddisk):**

<img width="606" height="235" alt="image" src="https://github.com/user-attachments/assets/f12df0f7-422e-4cab-af3e-67491d2eebaf" />

**Укажите пароль к пользователю cddisk из пункта 3.1 (из примера: cddisk):**

<img width="601" height="229" alt="image" src="https://github.com/user-attachments/assets/a0acda20-4b6f-4fd4-a450-f0dafd567bf3" />

**Измените на актуальный, если есть Корпоративный сервер 2019 и нажмите ОК:**

<img width="602" height="232" alt="image" src="https://github.com/user-attachments/assets/aa59c3a1-7687-4208-ab87-b64cab6ebfae" />


**Выберите Да:**

<img width="599" height="232" alt="image" src="https://github.com/user-attachments/assets/c2614cb8-a76a-4694-a568-9d2d8ae2af30" />


**Необходимо указать домен, в котором у вас созданы записи из пункта подготовки:**

<img width="602" height="229" alt="image" src="https://github.com/user-attachments/assets/b2279dd1-22ea-4c80-853d-521e68cdfdf8" />


Далее укажите необходимые префиксы для всех модулей.

**Выберите Да (если требуется установка почтового сервера):**

<img width="732" height="292" alt="image" src="https://github.com/user-attachments/assets/bf2e3ac5-aa69-4e71-a302-cfa3685c44f9" />

>[!Warning]
> - Дальнейшие действия нужно выполнять только при установке Корпоративного сервера 2024 с Почтовым сервером, иначе перезагрузите сервер.

**Выберите PostgreSQL:**

<img width="721" height="415" alt="image" src="https://github.com/user-attachments/assets/b12fb6a8-5ec2-4f5f-9b51-d0c97008917d" />


**Необходимо указать имя сервера:**

<img width="729" height="280" alt="image" src="https://github.com/user-attachments/assets/d6ba233f-d03e-4a12-83c5-6464983e7ec9" />

**Укажите IP-адрес сервера на котором вы проводите установку (данный сервер 2):**

<img width="730" height="289" alt="image" src="https://github.com/user-attachments/assets/5bcf9a5d-5ada-4a54-821f-37550f3f110b" />

Укажите пароль для пользователя postfix:

<img width="720" height="285" alt="image" src="https://github.com/user-attachments/assets/0ade2d4e-8812-4f16-b091-2b027891ddb5" />

**Если требуется установка SpamAssassin:**

<img width="733" height="427" alt="image" src="https://github.com/user-attachments/assets/3b2f38f5-49ab-4b3d-8419-fbcf2e1a49be" />

<img width="724" height="285" alt="image" src="https://github.com/user-attachments/assets/57962d80-2dc7-4215-b50b-554346773753" />

**После инсталляции в консоли будет предложено сделать TXT-запись:**

<img width="768" height="102" alt="image" src="https://github.com/user-attachments/assets/d99d57b9-b1b6-4481-a2fe-5ec9b295d4c5" />


Перезапустите **$${\color{red}СЕРВЕР}$$ $${\color{red}№2}$$**.

##### ##### 4.2 Переходим на сервер 1 для Установки Корпоративного сервера
>[!Warning]
> - Инструкция ниже выполняется **$${\color{red}НА}$$ $${\color{red}ПЕРВОМ}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№1}$$**

>[!Warning]
> - Перед установкой Корпоративного **$${\color{red}сервера}$$ $${\color{red}№1}$$** необходимо пересоздать базу данных, чтобы избежать дублирования информации.

**Это сделать обязательно!!!**
```
sudo -u postgres psql
входим
psql (11.22 (Debian 1:11.22-astra.se10.1))
Введите "help", чтобы получить справку.
postgres=#
postgres=#DROP DATABASE IF EXISTS cddisk;
\q
```
**Далее мы создадим базу данных заново на мастере из пункта 3**

Выполните перезапуск сервиса БД:
```cmd
sudo systemctl restart postgresql
```
>[!Warning]
> - Инструкция ниже выполняется **$${\color{red}НА}$$ $${\color{red}ПЕРВОМ}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№1}$$**

Cоздаем необходимую структуру в БД, создаем пользователей и настраиваем репликацию:
```cmd
sudo -u postgres psql
```
>[!Warning] Не рекомендуется использовать другие имена для баз данных cddisk и ds.

```cmd
CREATE USER cddisk WITH password 'cddisk';
CREATE USER ds WITH password 'ds';
CREATE DATABASE cddisk OWNER cddisk;
CREATE DATABASE ds OWNER ds;
CREATE DATABASE pagesdb OWNER cddisk;
GRANT ALL privileges ON DATABASE cddisk TO cddisk;
GRANT ALL privileges ON DATABASE ds TO ds;
GRANT ALL privileges ON DATABASE pagesdb TO cddisk;
CREATE USER replication_user WITH REPLICATION LOGIN PASSWORD 'replication_password';
GRANT CONNECT ON DATABASE cddisk TO replication_user;
GRANT CONNECT ON DATABASE ds TO replication_user;
\c cddisk
GRANT USAGE ON SCHEMA public TO replication_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO replication_user;
GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO replication_user;
\c ds
GRANT USAGE ON SCHEMA public TO replication_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO replication_user;
GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO replication_user;
Для выхода из БД
\q
```
Выполните перезапуск сервиса БД:
```cmd
sudo systemctl restart postgresql
```
##### Предварительная подготовка
>[!Warning]
> - Установка выполняется сначала **$${\color{red}НА}$$ $${\color{red}ВТОРОМ}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№2}$$**

Перейдите и скачайте дистрибутив на сервер № 2.

>[!NOTE]
> - Для корректной установки, разместите архив в директории, отличной от /root, например в /mnt или /tmp.
> - Нашу настройку двухнодовой архитектуры необходимо начать с установки на втором сервере, чтобы избежать последующих ошибок с серверами.

Перейдите в каталог:
```cmd
cd /mnt
```
>[!Warning]
> - Для offline установки требуется установить пакеты в систему и подключить ISO-образ установочного диска операционный системы в папку distr.

>[!TIP]
> - Скачать пакеты можно по данной ссылке https://nct.r7-office.ru/link/549705e3-5e21-49f1-afc4-57c88ecae674.

```
>[!Warning]
> - В папку ./distr положите ISO-образ установочного диска операционный системы. Файл должен быть с расширением .iso. Данный образ вы можете скачать с официального сайта производителя.

Распакуйте архивы:
```cmd
unzip CDinstall_*.zip
unzip cddisk.zip 
```
<img width="1112" height="265" alt="image" src="https://github.com/user-attachments/assets/484928c4-9421-470d-b25d-fc73f27649cc" />

Перейдите в каталог ``cd /mnt/cddisk/`` и установите пакеты:
```cmd
root@mx1:~# cd /mnt/cddisk/
root@mx1:/mnt/cddisk# ls
install.sh  repo
root@mx1:/mnt/cddisk#
root@mx1:/mnt/cddisk# chmod +x install.sh
root@mx1:/mnt/cddisk#./install.sh
```
После распаковки архивов, положите дистрибутивы в определенные папки distr и sslcert. 

**Дистрибутив 1.7.4-24.04.2023_14.23.iso в эту папку /mnt/CDDiskPack/CDinstall_Astra_1.7.4/distr#**

**Сертификаты в эту папку /mnt/CDDiskPack/CDinstall_Astra_1.7.4/sslcert#**
```cmd
root@mx1:~# ls /mnt/CDDiskPack/CDinstall_Astra_1.7.4/distr/
1.7.4-24.04.2023_14.23.iso
root@mx1:~# ls /mnt/CDDiskPack/CDinstall_Astra_1.7.4/sslcert/
 rosreestr.ru.cer    rosreestr.ru.key   'Корн Russian Trusted root.cer'  'Корн Russian Trusted sub.cer'
root@mx1:~#
```

>[!Warning]
> - Для корректной работы Корпоративного сервера 2024 обязательно требуется настройка HTTPS. Перед установкой скопируйте crt и key файлы в папку sslcert
> - Перед началам установки проверьте свои сертификаты

Проверка сертификатов и конвертирование в нужный формат 

Например, если мы имеем формат ``*.cer (rosreestr.ru.cer)`` его надо перевести в формат ``*.crt``
```cmd
openssl x509 -inform DER -in rosreestr.ru.cer -out rosreestr.ru.crt
```
Если мы имеем формат корневых сертификатов ``*.cer ('Корн Russian Trusted root.pem' и 'Корн Russian Trusted sub.pem')`` их требуется перевести в формат ``*.pem`` 
```cmd
openssl x509 -inform der -in Корн\ Russian\ Trusted\ root.cer -out Корн\ Russian\ Trusted\ root.pem
openssl x509 -inform der -in Корн\ Russian\ Trusted\ sub.cer -out Корн\ Russian\ Trusted\ sub.pem
```
Проверяем и добавляем в хранилище
```cmd
file rosreestr.ru.crt
head -5 rosreestr.ru.crt
openssl x509 -in rosreestr.ru.crt -text -noout | head -20
```
<img width="1064" height="418" alt="image" src="https://github.com/user-attachments/assets/6b146c3e-a6e6-43cd-ab51-0e58b60ba1fe" />

```cmd
cp rosreestr.ru.crt /usr/local/share/ca-certificates/
cp rosreestr.ru.key /usr/local/share/ca-certificates/
cp 'Корн Russian Trusted root.pem' /etc/ssl/certs/
cp 'Корн Russian Trusted sub.pem' /etc/ssl/certs/
update-ca-certificates -v
update-ca-certificates --fresh
```

#### Выполняем установку
Установка ``offline``

Предоставьте права на скрипт установки:
```cmd
chmod +x online_installer.sh
````
Если Offline установка
```cmd
chmod +x offline_installer.sh
```
>[!Warning]
> - Обязательно убедитесь, что все репозитории отключены, чтобы установка пакетов происходила исключительно из offline архива.
> - Для этого удалите или закомментируйте (добавив символ # в начало строки) все строки в файле /etc/apt/sources.list, а также очистите содержимое папки /etc/apt/sources.list.d.
> - Закомментируйте свой IP адрес шлюза

<img width="1116" height="572" alt="image" src="https://github.com/user-attachments/assets/2f39a0c8-6bab-44a8-8bce-6d7d251e222e" />

Проверряем
```cmd
ping 1.1.1.1
сеть не доступна 
```
После этого запустите установку:
```
./offline_installer.sh
```
**Выберите Нет, иначе произойдет удаление PostgreSQL:**

<img width="605" height="234" alt="image" src="https://github.com/user-attachments/assets/21b84d07-1bba-4d2f-9df3-026d2aa8cacf" />

**Выберите Нет:**

<img width="603" height="234" alt="image" src="https://github.com/user-attachments/assets/babd41a6-d193-4efb-865e-ad2df8cf22cd" />

**Выберите Да:**

<img width="606" height="235" alt="image" src="https://github.com/user-attachments/assets/14b9f9ff-9add-46f0-b265-f710d3b82f9d" />

**Задайте secret. Необходимо ввести секрет (Набор цифр, букв и спецсимволов. Длина от 8 символов) для защищённого доступа Р7-Диска и Сервера документов:**

<img width="603" height="234" alt="image" src="https://github.com/user-attachments/assets/04886b11-b06a-4e9e-bafa-f39f50d94394" />

**Укажите пароль к БД ds, ранее созданный в пункте 3.1 (из примера: ds):**

<img width="602" height="232" alt="image" src="https://github.com/user-attachments/assets/f8ef689b-ad72-459e-8ef8-7892c2f7a3ed" />

**Выберите Да:**

<img width="604" height="235" alt="image" src="https://github.com/user-attachments/assets/b66b095a-c625-4f78-ba34-b3f0173320f1" />

**Выберите PostgreSQL:**

<img width="403" height="277" alt="image" src="https://github.com/user-attachments/assets/d3d86bc1-3b71-40de-bd23-2d0ea4629f00" />

**Выберите Нет:**

<img width="604" height="233" alt="image" src="https://github.com/user-attachments/assets/2231193d-ff96-427e-98d9-aa01b7c7b925" />

**Укажите БД master и IP-адрес первого сервера 1 (мастер):**

<img width="600" height="231" alt="image" src="https://github.com/user-attachments/assets/b26c42b0-1d6e-4456-b5d6-af7081da67a5" />

**Укажите по умолчанию порт 5432:**

<img width="601" height="231" alt="image" src="https://github.com/user-attachments/assets/ad085a8d-bdbd-4f96-86ef-989c62a4e467" />


**Укажите БД cddisk из пункта 3.1 (из примера: cddisk):**

<img width="608" height="235" alt="image" src="https://github.com/user-attachments/assets/1fb3cb5e-c2b3-4fa7-b507-d847e7dd59bc" />


**Укажите системного пользователя postgres:**

<img width="602" height="229" alt="image" src="https://github.com/user-attachments/assets/b1b9a5aa-5d40-4cbd-835e-c4f5f7bb79bc" />

**Укажите пользователя cddisk:**

<img width="600" height="229" alt="image" src="https://github.com/user-attachments/assets/0a899566-6c6b-4322-979d-9814afa15755" />

**Укажите пароль к БД cddisk из пункта 3.1 (из примера: cddisk):**

<img width="606" height="235" alt="image" src="https://github.com/user-attachments/assets/f12df0f7-422e-4cab-af3e-67491d2eebaf" />

**Укажите пароль к пользователю cddisk из пункта 3.1 (из примера: cddisk):**

<img width="601" height="229" alt="image" src="https://github.com/user-attachments/assets/a0acda20-4b6f-4fd4-a450-f0dafd567bf3" />

**Измените на актуальный, если есть Корпоративный сервер 2019 и нажмите ОК:**

<img width="602" height="232" alt="image" src="https://github.com/user-attachments/assets/aa59c3a1-7687-4208-ab87-b64cab6ebfae" />


**Выберите Да:**

<img width="599" height="232" alt="image" src="https://github.com/user-attachments/assets/c2614cb8-a76a-4694-a568-9d2d8ae2af30" />


**Необходимо указать домен, в котором у вас созданы записи из пункта подготовки:**

<img width="602" height="229" alt="image" src="https://github.com/user-attachments/assets/b2279dd1-22ea-4c80-853d-521e68cdfdf8" />


Далее укажите необходимые префиксы для всех модулей.

**Выберите Да (если требуется установка почтового сервера):**

<img width="732" height="292" alt="image" src="https://github.com/user-attachments/assets/bf2e3ac5-aa69-4e71-a302-cfa3685c44f9" />

>[!Warning]
> - Дальнейшие действия нужно выполнять только при установке Корпоративного сервера 2024 с Почтовым сервером, иначе перезагрузите сервер.

**Выберите PostgreSQL:**

<img width="721" height="415" alt="image" src="https://github.com/user-attachments/assets/b12fb6a8-5ec2-4f5f-9b51-d0c97008917d" />


**Необходимо указать имя сервера:**

<img width="729" height="280" alt="image" src="https://github.com/user-attachments/assets/d6ba233f-d03e-4a12-83c5-6464983e7ec9" />

**Укажите IP-адрес сервера на котором вы проводите установку  (данный сервер 1):**

<img width="730" height="289" alt="image" src="https://github.com/user-attachments/assets/5bcf9a5d-5ada-4a54-821f-37550f3f110b" />

Укажите пароль для пользователя postfix:

<img width="720" height="285" alt="image" src="https://github.com/user-attachments/assets/0ade2d4e-8812-4f16-b091-2b027891ddb5" />

**Если требуется установка SpamAssassin:**

<img width="733" height="427" alt="image" src="https://github.com/user-attachments/assets/3b2f38f5-49ab-4b3d-8419-fbcf2e1a49be" />

<img width="724" height="285" alt="image" src="https://github.com/user-attachments/assets/57962d80-2dc7-4215-b50b-554346773753" />

**После инсталляции в консоли будет предложено сделать TXT-запись:**

<img width="768" height="102" alt="image" src="https://github.com/user-attachments/assets/d99d57b9-b1b6-4481-a2fe-5ec9b295d4c5" />


Перезапустите **$${\color{red}СЕРВЕР}$$ $${\color{red}№1}$$**.

#### 4.3 Дополнительная настройку Nginx и Сервер документов
Выведите значение параметра secure_link_secret на первом сервере:
```cmd
grep -rn "set \$secure_link_secret" /etc/r7-office/documentserver/nginx/ds.conf
```
Пример вывода:

13: set $secure_link_secret kCj7RMAAYCNtOh6KiGin;
Для второго сервера:
```cmd
sudo sed -i "s/set \$secure_link_secret [^;]*/set \$secure_link_secret НОВОЕ_ЗНАЧЕНИЕ/" $(grep -rl "set \$secure_link_secret" /etc/r7-office/documentserver/)
sudo sed -i -E "s/\"secretString\": .+/\"secretString\": \"НОВОЕ_ЗНАЧЕНИЕ\"/" $(grep -rl "secretString" /etc/r7-office/documentserver/)

Где, замените НОВОЕ_ЗНАЧЕНИЕ на необходимый параметр c вывода предыдущей команды (пример, kCj7RMAAYCNtOh6KiGin).
```

Измените в /etc/r7-office/documentserver/local.json строку:
```cmd
"dbHost": "localhost"
```
Где потребуется заменить localhost на адрес текущего мастера (первого сервера), из примера 192.168.27.135.

Выполните команды по перезапуску Nginx и Сервера документов:
```
systemctl restart nginx ds-converter.service ds-docservice.service ds-metrics.service
````
#### 4.4 Настройка подключения почтового сервера (*опционально)

Перейдите в https://admin.r16.rosreestr.ru/ Организации — Выберите организацию, в которую добавлены пользователи — Почтовые серверы:

Настройка подключения почтового сервера - интерфейс

**Укажите ранее добавленные данные по почтовому серверу:**

Настройка подключения почтового сервера - данные сервера

Скопируйте папку /home/mail_cddisk/.ssh из первого сервера во второй сервер.

Выполните на втором сервере:
```cmd
chown -R mail_cddisk:mail_cddisk /home/mail_cddisk/.ssh
```
#### 4.5 Управление переключением БД при неработоспособности первого сервера
##### Создайте скрипт управления
>[!Warning]
> - Готовый скрипт можно скачать по данной ссылке https://download.r7-office.ru/mailserver/scripts/db-switch-cs24/change.sh

Укажите необходимые константы в начале скрипта. Потребуется указать необходимые параметры, что является master (первый сервер) и slave (второй сервер).

##### Константы для подключения к БД
- MASTER_IP="X.X.X.X" — укажите адрес master БД;
- MASTER_MAIL_FQDN="mx10.r16.rosreestr.ru" — укажите FQDN имя почтового сервера на master;
- SLAVE_IP="X.X.X.X" — укажите адрес replica БД;
- REPLICATION_USER="replication_user" — укажите пользователя для репликации;
- REPLICATION_PASS="replication_password" — пароль от пользователя для репликации;
- LOG_FILE="/var/log/switch_postgres.log" — расположение файла логирования скрипта;
- PG_DATA="/var/lib/postgresql/11/main" — расположение каталога с базой;
- PG_BIN="/usr/lib/postgresql/11/bin" — расположение исполняемых файлов PostgreSQL.

##### Константы для cddisk (appsettings.json)
- CDDISK_DB_NAME="cddisk" — не рекомендуется изменять;
- CDDISK_DB_USER="cddisk" — укажите пользователя Корпоративного сервера 2024;
- CDDISK_DB_PASS="cddisk" — укажите пароль для пользователя Корпоративного сервера 2024;
- CDDISK_DB_PORT="5432" — укажите порт БД.

##### Константы для documentserver (local.json)
- DS_DB_NAME="ds" — не рекомендуется изменять;
- DS_DB_USER="ds" — укажите пользователя ДС;
- DS_DB_PASS="ds" — укажите пароль для пользователя ДС;
- DS_DB_PORT="5432" — укажите порт БД.

##### Константы для почтового сервера (postfix, dovecot)
- MAIL_DB_NAME="postfix" — не рекомендуется изменять;
- MAIL_DB_USER="postfix" — укажите пользователя Postfix;
- MAIL_DB_PASS="postfix" — укажите пароль пользователя Postfix;
- MAIL_DB_PORT="5432" — укажите порт БД.

Описание пунктов в скрипте:

1. Установка параметров master — устанавливает параметры master для сервера используемого основным (меняет конфигурации приложений на использование БД master) и создает в том же каталоге резервную копию изменяемых файлов;<br>
2. Установка параметров slave — устанавливает параметры slave для сервера используемым запасным (меняет конфигурации приложений на использование БД master и включение репликации на этом сервере) и создает в том же каталоге резервную копию изменяемых файлов;<br>
3. Показать текущие конфиги — показывает текущие параметры приложений;<br>
4. Проверка подключения с новыми параметрами — проверяет доступ для приложений с заданными константами по подключению к master;<br>
5. Восстановить конфигурации из .bak — при ранее измененных конфигураций приложений может восстановить резервные копии файлов из формата .bak;<br>
6. Перезапустить сервисы приложений — перезапускает сервисы приложений;<br>
7. Показать текущий статус сервера — указывает состояние БД на текущем сервере;<br>
8. Остановка сервисов корпоративного сервера (холодный резерв) — останавливает сервисы корпоративного сервера для режима «холодный резерв».

##### 4.5.1 Настройка второго сервера
Укажите в скрипте текущее представление серверов (master и slave) в константах скрипта (и проверьте другие параметры с корректными данными) и запустите скрипт на втором сервере (slave) пункт меню «Установка параметров slave».

##### 4.5.2 Проверка работы серверов
Для проверки потребуется переключать в DNS А запись ведущая на первый сервер. <br>Перейдите по адресу ``https://admin.r16.rosreestr.ru``, убедитесь что используется корректная адресация на первый адрес Корпоративного сервера 2024 (используйте команду ping) и используйте предустановленный логин\пароль superadmin. <br>Создайте пользователя и проверьте редактирование файлов — корректное сохранение файлов и повторное открытие файлов.

Далее переключите А запись на второй сервер и так же проверьте его работу.

В DNS используйте установленную текущую ноду как master. Запустите скрипт управления БД и проверьте текущие статусы серверов.

>[!Warning]
> - Настоятельно рекомендуется отработать поэтапное переключение из slave в master на втором сервере в случае ошибок на первом сервере.

#### 5. Настройка LDAP

###### подключение по LDAP на почтовом сервере

<img width="1517" height="636" alt="image" src="https://github.com/user-attachments/assets/b60fb34c-b21c-44aa-9e5c-6f273d9f73b5" />

<img width="1317" height="1058" alt="image" src="https://github.com/user-attachments/assets/bb99b7c7-122c-4b2e-a331-ad600c422c6f" />

<img width="1285" height="1218" alt="image" src="https://github.com/user-attachments/assets/69b192a7-6ecd-44c6-a69e-5db97da50a97" />

<img width="1451" height="1224" alt="image" src="https://github.com/user-attachments/assets/5d36d1a8-eada-412a-acb8-203f563a09c5" />

###### миграция пользователей из AD

<img width="1607" height="1171" alt="image" src="https://github.com/user-attachments/assets/3c830d97-0546-47ed-822f-a562a684aa38" />

###### создание пользователя и почтового ящика

<img width="905" height="738" alt="image" src="https://github.com/user-attachments/assets/e32373eb-3d75-4c0a-9025-115646fd1bf8" />

<img width="902" height="515" alt="image" src="https://github.com/user-attachments/assets/3155f9bb-f877-42e3-b516-a560ceb5b5ff" />

<img width="1608" height="399" alt="image" src="https://github.com/user-attachments/assets/cb4872b1-aca4-4f59-86f4-1db220f46295" />

<img width="518" height="350" alt="image" src="https://github.com/user-attachments/assets/22f1158b-5b06-4297-a265-0590c8d0e958" />

<img width="1606" height="392" alt="image" src="https://github.com/user-attachments/assets/02aed2b5-e0c4-4ebb-8248-92939fdd783c" />

###### проверка работы почтового адреса (хождение внутренней почты) на самом сервере Р7

<img width="1769" height="838" alt="image" src="https://github.com/user-attachments/assets/5601eaed-5f71-465d-b0d9-e2b6a25a89ed" />

<img width="1626" height="495" alt="image" src="https://github.com/user-attachments/assets/7291c653-00c9-40f0-b154-4d4bad49ee84" />

<img width="1486" height="282" alt="image" src="https://github.com/user-attachments/assets/0750afc5-f17c-4fb8-82c3-a2de7f85c748" />

<img width="1479" height="550" alt="image" src="https://github.com/user-attachments/assets/24db74bc-53ae-439c-8065-a8190981882c" />

<img width="924" height="737" alt="image" src="https://github.com/user-attachments/assets/9d1d89dc-96f1-4c64-9066-9d5be7bd2c3f" />

<img width="1038" height="539" alt="image" src="https://github.com/user-attachments/assets/96823279-ab9f-46ab-8d03-bae02ac3debb" />

<img width="1470" height="349" alt="image" src="https://github.com/user-attachments/assets/e122ec34-dabd-45a1-885d-b3f00881b71f" />

<img width="1471" height="504" alt="image" src="https://github.com/user-attachments/assets/710152d3-215a-4001-a311-60e4d591fd0a" />

##### настройка DNS записей на сервере ALDPRO (настройка почтовых протоколов)

![image](https://github.com/user-attachments/assets/f50eada9-4fd0-49b9-932b-0758da912a42)

Настройка SRV-записей для почтового сервера помогает клиентам автоматически находить сервисы (SMTP, IMAP и т.д.) через DNS. Вот пошаговая инструкция:

###### 1. **Основные параметры SRV-записи**
Формат записи:  
`_Сервис._Протокол.Домен. TTL Класс SRV Приоритет Вес Порт Цель`

Пример:  
`_submission._tcp.ваш-домен. 3600 IN SRV 10 5 587 mx1.ваш-домен.`

###### 2. **Ключевые сервисы для почты**
- **SMTP (отправка):**
  - `_submission._tcp` (порт 587) — для клиентской отправки
  - `_smtps._tcp` (порт 465) — SMTP over SSL
- **IMAP (получение):**
  - `_imap._tcp` (порт 143)
  - `_imaps._tcp` (порт 993) — IMAP over SSL
- **POP3 (получение):**
  - `_pop3._tcp` (порт 110)
  - `_pop3s._tcp` (порт 995) — POP3 over SSL
- **Autodiscover (автонастройка):**
  - `_autodiscover._tcp` (порт 443)

###### 3. **Примеры записей**
```dns
; Отправка почты (клиенты)
_submission._tcp.example.com.  3600 IN SRV 10 5 587 mail.example.com.

; Получение почты (IMAP)
_imaps._tcp.example.com.       3600 IN SRV 10 0 993 mail.example.com.

; Autodiscover (для Outlook/Thunderbird)
_autodiscover._tcp.example.com. 3600 IN SRV 10 0 443 mail.example.com.
```

###### 4. Параметры
- **Приоритет (Priority):** Меньше значение → выше приоритет.  
- **Вес (Weight):** Балансировка нагрузки между серверами одного приоритета.  
- **Порт (Port):** TCP-порт сервиса (587, 993 и т.д.).  
- **Цель (Target):** FQDN почтового сервера (должен иметь A/AAAA-запись).  

*** 

###### 5. Как добавить запись
1. Зайдите в панель управления DNS-хостингом (Cloudflare, REG.RU и т.д.).  
2. Создайте новую запись типа **SRV**.  
3. Заполните поля по шаблону:  
   - **Service:** `_submission._tcp` (или другой сервис)  
   - **Target:** `mail.example.com` (ваш сервер)  
   - **Priority:** `10`  
   - **Weight:** `5`  
   - **Port:** `587`  

*** 

###### 6. **Проверка**
Используйте команды:  
```bash
dig SRV _submission._tcp.example.com
# или
nslookup -type=SRV _submission._tcp.example.com
```

###### Важные нюансы
1. **Поддержка клиентов:**  
   SRV-записи работают не со всеми клиентами (Outlook поддерживает для Autodiscover, Thunderbird — для IMAP/SMTP).  
2. **Обязательные A/AAAA-записи:**  
   Убедитесь, что `mail.example.com` разрешается в IP-адрес.  
3. **Autodiscover:**  
   Для Exchange/Office 365 используйте `_autodiscover._tcp` + HTTPS-ресурс `https://autodiscover.example.com/autodiscover/autodiscover.xml`.  
4. **Безопасность:**  
   Для портов 465/587/993 используйте SSL/TLS.  

###### A, TXT, PTR и MX-записи
- **MX-записи:** Для входящей почты (не для SRV).  

Необходимо добавить запись А (ваш почтовый сервер hostname -f) и обратную запись, а также запись MX и TXT v=spf1 +mx ~all
Пример:

|        |it.company.lan       	|TTL          	|Приоритет
|--------|-----------------------|---------------|--------------|
|MX	 |mx10.ваш-домен.  |300            |10		|
|TXT     |ваш-домен.        |TTL            |		|
|	 |v=spf1+mx~all          |300            |		|
|A       |mx10.ваш-домен.  |TTL            |		|
|	 |192.168.18.141          |300            |		|
   
Теперь по подробней.

**MX-запись** — это тип DNS-записи, который указывает, какой сервер отвечает за прием электронной почты для домена.<br> 
MX-запись указывает на доменное имя почтового сервера (например, в нашем случае - r7mx1.it.company.lan), которое должно иметь A-запись (IPv4), чтобы связать домен с IP-адресом. Чем меньше число, тем выше приоритет.

>MX-записи не могут указывать напрямую на IP-адрес, только на доменное имя.

Проверить MX-записи можно через команды в терминале:
```bash
nslookup -type=mx ваш-домен
или так
dig mx ваш-домен
```
Запись ``v=spf1 +mx ~all`` в DNS — это SPF-запись, которая помогает защитить домен от подделки электронной почты (спуфинга). <br>Она указывает, какие серверы имеют право отправлять письма от имени вашего домена.<br>
SPF-запись v=spf1 +mx ~all разрешит отправку писем только с r7mx1.it.company.lan, а письма с других серверов будут отклонены или помечены.

Если всё настроили то записи долны быть примерно такими.

![image](https://github.com/user-attachments/assets/b5879541-2b67-4e66-9a13-ff081426bbf8)

![image](https://github.com/user-attachments/assets/860e925f-a5c0-49e4-88fb-d4044db46a81)

#### 6.	Настройка API для работы с почтовым сервером
##### Предварительная установка
Скачать архив с API методами:
```bash
wget https://download.r7-office.ru/mailserver/mailserver_api_pgsql_astra9.tar.gz
```
![image](https://github.com/user-attachments/assets/5bf17a9a-bdb4-43db-a2fd-823feb9e55d2)

Распаковать архив с api и добавить сервис как службу
```bash
tar -xzvf mailserver_api_pgsql_astra9.tar.gz --selinux -C /
```
![image](https://github.com/user-attachments/assets/922249c4-6d93-428c-b7f5-96ea7c2b589d)

Создайте службу systemd для почтового api:
```bash
nano /etc/systemd/system/mailserver_api.service
```
вставив описание для файла:
```bash
[Unit]
Description=Mailserver API Service
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/r7-office/mailserver_api
ExecStart=/opt/r7-office/mailserver_api/mailserver_api
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
```
![image](https://github.com/user-attachments/assets/ea2470f1-a9cf-4e62-b579-5b378330c578)

Перезагрузите systemd:
```bash
systemctl daemon-reload
```
Запустите службу api добавив в автозагрузку:
```bash
systemctl enable mailserver_api --now
```
Проверьте статус службы api:
```bash
systemctl status mailserver_api
```
![image](https://github.com/user-attachments/assets/6146a54d-8c9e-4dde-8418-fa0a8a996a71)

##### Установка htpasswd на сервер.
Для deb:
```bash
apt-get install apache2-utils
```
![image](https://github.com/user-attachments/assets/4a0a4b26-5647-42cf-b0b0-b6267b8860a0)

Создание пользователя и пароля.
```bash
sudo htpasswd -c /etc/nginx/auth.basic admin
```
###### Встраивание API в Корпоративный сервер 2024 для работы с запросами.

Необходимо дополнить файл `/etc/nginx/sites-available/admin` добавив секцию в файл. Добавочная секция:
```bash
        location /apimail {
            proxy_pass http://localhost:8084;
            auth_basic "Restricted area";
            auth_basic_user_file /etc/nginx/auth.basic;  
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
        }
```
>если ПС находиться на другом сервере, то localhost измените на ip адрес сервера почтового сервера.

![image](https://github.com/user-attachments/assets/ee43841b-cdf7-4104-9352-6e2b369c7632)

Перезапустите nginx:
```bash
nginx -s reload
```
![image](https://github.com/user-attachments/assets/11c816b0-6e3b-4ab5-ae5e-3245276e07b1)

Обновить БД для работы со всеми доступными методами `api` и функциональными возможностями почтового сервера
```bash
wget http://download.r7-office.ru/mailserver/scripts/upgrate_mail_db.sh
далее
sed -i 's/--username "\${DB_USER}"/--username postgres/g' ./upgrate_mail_db.sh
далее
sudo bash upgrate_mail_db.sh
```
![image](https://github.com/user-attachments/assets/cad5ea93-3681-4ed1-9183-b8dea1070b6a)

#### Установка и настройка модуля dovecot и postfix.
##### Настройка модуля postfwd.

>Установить зависимости для postfwd:

```bash
apt install libcgi-pm-perl libio-multiplex-perl libnet-cidr-perl libnet-server-perl
```
![image](https://github.com/user-attachments/assets/ee3f9568-87b3-4cd6-8424-17b50eb7593b)

Скачать и установить пакет postfwd:
```bash
wget http://download.r7-office.ru/mailserver/pkg/postfwd_1.35-8_all.deb
Далее распаковываем и устанавливаем
apt install ./postfwd_1.35-8_all.deb
```
![image](https://github.com/user-attachments/assets/521e73ad-0912-427b-b3e2-b3bb726f17f0)

Настроить модуль postfwd.
```bash
touch /etc/postfix/postfwd.cf 
```
Открываем в редакторе `nano /etc/default/postfwd`.

Меняем `STARTUP=0` на `STARTUP=1` 
```bash
systemctl start postfwd
systemctl enable postfwd
```
![image](https://github.com/user-attachments/assets/89a16920-5958-442a-b73d-27b472dbe672)

Проверить слушается порт 10040:
```bash
ss -tulpn | grep 10040
```
![image](https://github.com/user-attachments/assets/a8cd76cf-9dd9-4e26-b2eb-bb6c70b00af6)

Настроить `postfix` для работы c `postfwd`.

Открываем в редакторе `nano /etc/postfix/main.cf`

Закоментировать:
```bash
smtpd_recipient_restrictions = permit_sasl_authenticated,
 reject_non_fqdn_recipient,
 reject_unknown_recipient_domain,
 reject_multi_recipient_bounce,
 reject_unauth_destination,
```
![image](https://github.com/user-attachments/assets/0b66f642-0528-442c-b679-e9d474926f4e)

Ниже добавить:
```bash
# Подключаем postfwd и разрешаем отправку только авторизированным пользователям. Подключаем белый/черный список.
 smtpd_recipient_restrictions = permit_mynetworks,
 check_policy_service inet:127.0.0.1:10040,
 permit_sasl_authenticated,
 reject_unauth_destination,
 check_sender_access hash:/etc/postfix/access,
 reject_non_fqdn_helo_hostname,
 reject_non_fqdn_sender,
 reject_non_fqdn_recipient,
 reject_unknown_recipient_domain,
 reject_unknown_sender_domain

# Подключаем postfwd
 smtpd_end_of_data_restrictions = check_policy_service inet:127.0.0.1:10040
```
![image](https://github.com/user-attachments/assets/91785ea1-e4d9-47aa-9217-c536e5aea2f9)

Перезапустите службы Dovecot и Postfix:
```bash
systemctl restart dovecot postfix
```
Проверяем статус
```bash
systemctl status dovecot postfix
```
![image](https://github.com/user-attachments/assets/c47e858a-d03a-4a8f-a7ca-02bf661c6368)

#### Настройка модуля quota для dovecot с настройкой подключения через LDAP.
Установите пакеты для возможности работы по протоку `ldap`.
```bash
apt install dovecot-ldap slapd ldap-utils libldap2-dev
```
![image](https://github.com/user-attachments/assets/1ee07c67-fb94-4b1b-b6b5-644380b05824)

Создайте файл подключения к `LDAP`<br>
Открываем в редакторе `nano /etc/dovecot/dovecot-ldap.conf`
 
Содержимое:
```bash
hosts = IP адрес LDAP ALDPRO:389
ldap_version = 3
auth_bind = yes
dn = uid=vmail,cn=users,cn=accounts,dc=urrca,dc=esk
dnpass = ****** пароль на авторизацию LDAP
base= cn=users,cn=accounts,dc=urrca,dc=esk
scope = subtree
deref = never
user_filter = (&(mail=%u)(objectClass=person))
pass_filter = (&(mail=%u)(objectClass=person))
user_attrs = mailUidNumber=1100,mailGidNumber=1100
pass_attrs = userPassword=password
default_pass_scheme = CRYPT
```
Где
```bash
hosts — адрес или имя  сервера ldap 
auth_bind — указываем, нужно ли выполнять аутентификацию при связывании с LDAP.
ldap_version — версия ldap.
dn — учетная запись для прохождения авторизации при связывании со службой каталогов.
dnpass — пароль от записи для прохождения авторизации.
base — базовый контейнер, в котором мы ищем наших пользователей. Нельзя использовать поиск на уровне домена. 
scope — указывает на каком уровне нужно искать пользователей:
                subtree — во всех вложенных контейнерах.
                onelevel — во всех вложенных контейнерах, но на один уровень.
                base — только в контейнере, который указан в base.
deref — параметр означает использование поиска по разыменованным псевдонимам.
user_filter — фильтр для поиска учетных записей пользователей.
pass_filter — фильтр для поиска паролей пользователей. 
pass_attrs  — соответствие между атрибутами найденного объекта ldap и внутренними переменными пользователя Dovecot.
default_pass_scheme — схема хранения паролей.
```
![image](https://github.com/user-attachments/assets/760c840b-ebf5-4edd-953a-ccfbe6afc51c)

Откройте в редакторе конфигурационный файл dovecot.conf `nano /etc/dovecot/dovecot.con`.

```bash
nano /etc/dovecot/dovecot.conf
```
Убедитесь, что в секции `mail_plugins` добавлен плагин `quota`.

```bash
mail_plugins = mailbox_alias acl quota
```
Добавьте плагин imap_quota в секцию protocol imap.
```bash
protocol imap {
 mail_plugins = $mail_plugins imap_acl imap_quota
 imap_client_workarounds = tb-extra-mailbox-sep
 mail_max_userip_connections = 1500
}
```
Добавьте плагин quota в секцию protocol lmtp.
```bash
protocol lmtp {
 info_log_path = /var/log/dovecot/lmtp.log
 mail_plugins = quota sieve
 postmaster_address = postmaster
 lmtp_save_to_detail_mailbox = yes
 recipient_delimiter = +
}
```
![image](https://github.com/user-attachments/assets/f60685c1-3000-4215-b244-33fc99316a7b)

В самом низу добавьте строки.
```bash
service dict {
    unix_listener dict {
    mode = 0660
    user = vmail
    group = vmail
  }
}

plugin {
    quota = maildir:User quota
}

dict {
    sql = pgsql:/etc/dovecot/dovecot-dict-sql.conf.ext
}

passdb {
 args = /etc/dovecot/dovecot-ldap.conf
 driver = ldap
 }
```
![image](https://github.com/user-attachments/assets/fa1b89a9-80a2-496e-8a0f-e049f3d357bc)

Отредактировать файл dovecot-dict-sql.conf.ext.
```bash
nano /etc/dovecot/dovecot-dict-sql.conf.ext
```
Закомментировать или удалить содержимое и добавить следующие строки:
```bash
map {
  pattern = priv/quota/storage
  table = virtual_users
  username_field = email
  value_field = quota
}
```
![image](https://github.com/user-attachments/assets/7fe96da0-38cd-4084-a2ef-5ffcf55278c5)

Откройте файл dovecot-pgsql.conf.
```bash
nano /etc/dovecot/dovecot-pgsql.conf
```
Измените строку user_query, чтобы добавить квоты:
```bash
user_query = SELECT '/mail/%d/%u' as home, 'maildir:/mail/%d/%u' as mail, NULL AS uid, NULL AS gid, '*:storage=' || quota AS quota_rule FROM virtual_users WHERE email = '%u'
```
![image](https://github.com/user-attachments/assets/817df5f3-ac57-4876-9e15-6f346133204a)

Проверить квоты на почтовом ящике.
```bash
doveadm quota get -u user@example.com
```
Перезапустите службы Dovecot и Postfix.
```bash
systemctl restart dovecot postfix
```
JWT-токен.
```bash
cat /opt/r7-office/mailserver_api/jwt_token
```
>Сохраните вывод команды для дальнейшего использования Api. 

![image](https://github.com/user-attachments/assets/f9468167-0106-484b-a096-cdaef601d169)

#### 8.	Настройка Autodiscover для корпоративного почтового сервера Р7
### Настройка Autodiscover для корпоративного почтового сервера Р7

Для настройки Autodiscover в **Корпоративном почтовом сервере Р7** выполните следующие шаги:

#### 1.Подготовка DNS-записей
Добавьте в DNS вашего домена:
```bash
# Основная запись
autodiscover.IN.CNAME mx10.r16.rosreestr.ru

# Альтернативно (если не поддерживается CNAME)
autodiscover.IN.A 192.168.25.91

# SRV-запись для улучшения совместимости
_autodiscover._tcp.IN.SRV 10 0 443 mx10.r16.rosreestr.ru
```
Пример с ALD PRO:

| Тип      | Имя                         | Значение                     | TTL  |
|----------|-----------------------------|------------------------------|------|
| `CNAME или A`  | `autodiscover`        | `mx10(имя почтового сервера)`| 3600 |
| `A`      | `mx10`                      | `192.168.25.91`        | 3600 |
| `SRV`    | `_autodiscover._tcp`        | `10 0 443 mx10` | 3600 |

---

#### 2.Создание XML-файла Autodiscover

Autodiscover в Р7 реализуется через **XML/JSON-файл** на веб-сервере.

Создайте папку `mkdir /var/www/autodiscover`

![image](https://github.com/user-attachments/assets/eb247d73-330c-4c82-b018-c92849a7bf62)

Создайте файл `touch /var/www/autodiscover/autodiscover.xml` 

![image](https://github.com/user-attachments/assets/1b5ea516-be5c-499d-af85-46d6dc67b9ee)

Создайте файл `nano /var/www/autodiscover/autodiscover.xml` заполните содержимым:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<Autodiscover xmlns="http://schemas.microsoft.com/exchange/autodiscover/responseschema/2006">
  <Response>
    <Account>
      <AccountType>email</AccountType>
      <Protocol>
        <Type>IMAP</Type>
        <Server>mx10.r16.rosreestr.ru</Server>
        <Port>993</Port>
        <LoginName>%EMAILADDRESS%</LoginName>
        <SSL>on</SSL>
        <AuthRequired>on</AuthRequired>
      </Protocol>
      <Protocol>
        <Type>SMTP</Type>
        <Server>mx10.r16.rosreestr.ru</Server>
        <Port>587</Port>
        <SSL>starttls</SSL>
        <AuthRequired>on</AuthRequired>
      </Protocol>
    </Account>
  </Response>
</Autodiscover>
```
![image](https://github.com/user-attachments/assets/28147b1b-8bdd-494b-8072-0065061a923f)

---

#### 3.Настройка веб-сервера (Nginx)
Добавьте конфигурацию в файл `nano /etc/nginx/conf.d/autodiscover.conf`:

```nginx
server {
    listen 443 ssl;
    server_name autodiscover.it.company.lan;

    # SSL-сертификат (должен включать autodiscover.ваша-компания.ru)
    ssl_certificate /etc/nginx/ssl/r16.rosreestr.ru.crt;
    ssl_certificate_key /etc/nginx/ssl/r16.rosreestr.ru.key;

    # Основной endpoint
    location = /autodiscover/autodiscover.xml {
        alias /var/www/autodiscover/autodiscover.xml;
        default_type application/xml;
    }

    # Для совместимости с Outlook
    location = /Autodiscover/Autodiscover.xml {
        alias /var/www/autodiscover/autodiscover.xml;
        default_type application/xml;
    }

    # Thunderbird autoconfig
    location = /.well-known/autoconfig/mail/config-v1.1.xml {
        alias /var/www/autodiscover/thunderbird.xml;
        default_type application/xml;
    }
}
```
![image](https://github.com/user-attachments/assets/9acdc8ab-133d-429e-b96b-7dba6c345054)

Перезагрузите Nginx:  
```bash
проверить запись на ошибки
nginx -t

systemctl reload nginx
```
![image](https://github.com/user-attachments/assets/731787a0-0b67-4e4f-9128-ed25cf3b92bb)

---

#### 4.Дополнительно: Файл для Thunderbird
Создайте файл `nano /var/www/autodiscover/thunderbird.xml`:
```xml
<?xml version="1.0"?>
<clientConfig version="1.1">
  <emailProvider id="r16.rosreestr.ru">
    <domain>r16.rosreestr.ru</domain>
    <displayName>Почта Вашей Компании</displayName>
    <incomingServer type="imap">
      <hostname>r7mx1.it.company.lan</hostname>
      <port>993</port>
      <socketType>SSL</socketType>
      <authentication>password-encrypted</authentication>
    </incomingServer>
    <outgoingServer type="smtp">
      <hostname>mx10.r16.rosreestr.ru</hostname>
      <port>587</port>
      <socketType>STARTTLS</socketType>
      <authentication>password-encrypted</authentication>
    </outgoingServer>
  </emailProvider>
</clientConfig>
```
---

#### 5.Проверка работы
1. **Тест в браузере**:  
   Откройте `https://autodiscover.r16.rosreestr.ru/autodiscover/autodiscover.xml` → Должен отобразиться XML.

![image](https://github.com/user-attachments/assets/6659354c-27e3-4c35-8ed0-da0c21139684)

2. **Тест через Outlook**:
   ```powershell
   Test-EmailAutoConfiguration -Identity info@r16.rosreestr.ru -Protocol Autodiscover

3. **Тест через telnet/openssl**:
   ```bash
   openssl s_client -connect autodiscover.r16.rosreestr.ru:443
   GET /autodiscover/autodiscover.xml HTTP/1.1
   Host: autodiscover.it.company.lan
   ```
   → Убедитесь, что возвращается XML.```
---

#### 6.Решение проблем
| Ошибка | Решение |
|-------|---------|
| *404 Not Found* | Проверьте пути в Nginx и права доступа к файлам (`chmod 644`) |
| *SSL-ошибки* | Убедитесь, что сертификат включает `autodiscover.it.company.lan` |
| *Outlook не подхватывает настройки* | Добавьте SRV-запись в DNS |
| Сертификат не доверенный          | Используйте сертификат от Let's Encrypt или коммерческого ЦС. |
| Клиент игнорирует Autodiscover    | Убедитесь, что в DNS есть CNAME и SRV-запись.                 |
| Блокировка фаерволом              | Откройте порт 443 для `autodiscover.it.company.lan`.        |
| Неверный Content-Type             | Укажите в веб-сервере: `application/xml`.                     |

---

#### 7.Оптимизация для Р7
1. **Интеграция с LDAP/AD**:  
   В файле `autodiscover.xml` укажите:
   ```xml
   <LoginName>%USERNAME%@it.company.lan</LoginName>
   ```

2. **Поддержка ActiveSync**:  
   Добавьте в XML:
   ```xml
   <Protocol>
     <Type>ActiveSync</Type>
     <Server>mx10.r16.rosreestr.ru</Server>
     <Port>443</Port>
     <SSL>on</SSL>
   </Protocol>
   ```

3. **Безопасность**:  
   Ограничьте доступ по IP в Nginx:
   ```nginx
   allow 192.168.1.0/24;
   allow 203.0.113.5;
   deny all;
   ```
---

### Важные особенности Р7:
1. **Стандартные порты**:
   - IMAPS: 993
   - SMTPS: 465
   - Submission: 587

2. **Аутентификация**:  
   Для Outlook требуется:
   ```xml
   <AuthRequired>on</AuthRequired>
   ```

3. **Поддержка переменных**:  
   Р7 понимает:
   - `%EMAILADDRESS%` → user@domain.ru
   - `%USERNAME%` → логин без домена


### 8.Альтернатива: Autoconfig
Для совместимости с Thunderbird создайте дополнительно файл:  
`https://mail.ваша-компания.ru/.well-known/autoconfig/mail/config-v1.1.xml`

Пример:
```xml
<?xml version="1.0"?>
<clientConfig version="1.1">
  <emailProvider id="ваша-компания.ru">
    <domain>ваша-компания.ru</domain>
    <incomingServer type="imap">
      <hostname>mail.ваша-компания.ru</hostname>
      <port>993</port>
      <socketType>SSL</socketType>
      <authentication>password-cleartext</authentication>
    </incomingServer>
    <outgoingServer type="smtp">
      <hostname>mail.ваша-компания.ru</hostname>
      <port>587</port>
      <socketType>STARTTLS</socketType>
      <authentication>password-cleartext</authentication>
    </outgoingServer>
  </emailProvider>
</clientConfig>
```
---

#### 9.	Настройка брандмауэра(firewalld)
### Устанавливаем и запускаем.
```bash
apt install firewalld -y
systemctl start firewalld
```
### Добавляем правила.
#### Для Dovecot и Postfix.
```bash
firewall-cmd --zone=public --add-service=smtp # 25 порт
firewall-cmd --zone=public --add-service=smtps # 465 порт
firewall-cmd --zone=public --add-service=imap # 143 порт
firewall-cmd --zone=public --add-service=imaps # 993 порт
firewall-cmd --zone=public --add-service=smtp-submission # 587 порт
```
#### SSH.
```bash
firewall-cmd --zone=public --add-service=ssh # 22 порт ssh
firewall-cmd --zone=public --add-port=2345/tcp # пример добавления любых tcp портов
```
#### GlusterFS.
```bash
firewall-cmd --zone=internal --add-service=glusterfs
firewall-cmd --zone=internal --add-port=49150-49160/tcp # Порт из п.3.3 (первоначально 49152), на нём слушается volume /mail_volume. Если будете создавать новые, то они будут занимать следующие порты по порядку#PgSQL
firewall-cmd --zone=internal --add-service=pgsql
```
##### Добавляем с какого диапозона или ip возможно подключение к PgSQL и GlusterFS.
```bash
firewall-cmd --zone=internal --add-source=192.168.25.0/24
```
#### Добавляем в автозагрузку.
```bash
sudo systemctl enable --now firewalld
```
#### Проверяем правила, лишние порты и сервисы можете удалить.
```bash
firewall-cmd --zone=public --list-all
firewall-cmd --zone=internal --list-all
```
#### Применяем правила на постоянное использование.
```bash
firewall-cmd --runtime-to-permanent # применения правил на постоянной основе
firewall-cmd --reload # перезагружаем firewalld
```


#### 10. Резервное копирование и восстановление
Для проведения резервирования и восстановления необходимо использовать скрипты из статьи Резервное копирование/восстановление Корпоративный сервер 2024. https://support.r7-office.ru/corporate-server2024/settings_cs-r7disk/rezervnoe-kopirovanie-vosstanovlenie-r7-disk/

Перед использованием скрипта создания бекапа добавьте каталог mail, приведите строку к виду:

#### Создание архива с бэкапом
```cmd
tar cf "$backup_dir/cddisk-${backup_date}.tar.bz2" --selinux --use-compress-prog="lbzip2 -k -n$num_cores" /opt/r7-office $supervisor_dir /etc/r7-office /var/r7-office /var/www/r7-office "$backup_dir/cddisk_db.tar.gz /mail"
```
При восстановлении на мастер ноде рекомендуется остановить службу:
```
systemctl stop glusterfs
```
И после завершения восстановления включить:
```
systemctl start glusterfs
```
При восстановлении резервной ноды нет необходимости выполнения восстановления, так как скрипт позволяет назначить вторую ноду репликой первой для БД и автоматическую синхронизацию каталогов производится средствами glusterfs.

#### 11. Установка и настройка Органайзера

>[!NOTE] Присание установки Органайзера в файле с названием ``Установка Органайзера.md``





















































