### Инструкция по установке почтового сервера отказоустойчивая архитектура (ОС Astra Linux Orel 1.7.4)

Содержание.

1.	Подготовка к установке
    - подготовка ПО Астра Линукс (настройка сети, установка обновлений, установка дополнительных программ) на сервере 1
    - подготовка ПО Астра Линукс (настройка сети, установка обновлений, установка дополнительных программ) на сервере 2
2. Установка GlusterFS и базы данных PostgreSQL<br>
    2.1 Установка GlusterFS и базы данных PostgreSQL на сервере 1<br> 
    2.2 Установка GlusterFS и базы данных PostgreSQL на сервере 2<br>
    2.3 Создание томов<br>
3. Установка и настройка БД<br>
    3.1 Настройка БД на сервере 1<br>
    3.2 Настройка БД на сервере 2<br>
    3.3 Настройка репликации БД<br>
4. Установка Корпоративного сервера<br> 
    4.1 Установка Корпоративного сервера на сервере 2<br>
    4.2 Установка Корпоративного сервера на сервере 1<br>
    4.3 настройка Nginx и Сервер документов<br>
    4.4 настройка подключения почтового сервера (*опционально)<br>
    4.5 Управление переключением БД при неработоспособности первого сервера (скрипт управления)<br>
5.	Настройка LDAP
      - настройка DNS записей на сервере ALDPRO (настройка почтовых протоколов)
      - подключение по LDAP на почтовом сервере
      - миграция пользователей из AD
      - проверка работы почтового адреса (хождение внутренней почты) на самом сервере Р7
      - создание почтовых ящиков   
6.	Настройка API для работы с почтовым сервером
      - настройка подключения почтового сервера (*опционально)
      - установка htpasswd на сервер
      - установка и настройка модуля dovecot и postfix
      - настройка модуля quota для dovecot с настройкой подключения через LDAP
7.	Настройка Autodiscover для корпоративного почтового сервера Р7
8.	Настройка брандмауэра(firewalld)
10.	Резервное копирование и восстановление
11.	Установка и настройка Органайзера

#### Системные требования.
```bash
Поддерживается только 64-битная архитектура 
2 Виртуальные машины
Для хранения данных glusterfs
ТХ Машин, для тестирования, возможно использовать:
- от 4 CPU;
- от 8Гб RAM;
- от 50Гб свободного пространства на диске;
Более конкретные данные рассчитываются по обращению в ТП
Отключение или перевод selinux в режим permissive для корректной работы сервисов
```
>[!WARNING]
>Минимальные системные требования рассчитаны при одновременной работе до 300 пользователей

В архитектуре используются следующие компоненты и входят в состав стандартной установки Корпоративного сервера 2024:
```bash
PostgreSQL 11
RabbitMQ-server 3.13.7
Redis server 7.2.7
glusterfs 5.5
```
****
#### 1. Подготовка к установке
##### Подготовка ПО Астра Линукс (настройка сети, установка обновлений, установка дополнительных программ) на сервере 1   

- Скачаваем образ **1.7.4-24.04.2023_14.23.iso**
- Скачайте архив Корпоративный сервер 2024 для установки **Оффлайн установкаТекущая версия: 2025.3.12.15877**
- Скачайте архив `cddisk.zip` который содержит пакеты для корпоративного сервера 2024
- Подготовьте сертификаты

>[!WARNING]
>Для установки потребуется wildcard сертификат, содержащий полную цепочку (fullchain)

Например:
```cmd
—-BEGIN CERTIFICATE——
(Your Primary SSL certificate: your_domain_name.crt)
——END CERTIFICATE——
——BEGIN CERTIFICATE——
(Your Intermediate certificate: DigiCertCA.crt)
——END CERTIFICATE——
——BEGIN CERTIFICATE——
(Your Root certificate: TrustedRoot.crt)
——END CERTIFICATE——
```
>Где:
> - Основной Certificate — your_domain_name.crt
> - Промежуточный Certificate — DigiCertCA.crt
> - Корневой Certificate — TrustedRoot.crt

**Ссылки:**
- https://support.r7-office.ru/corporate-server2024/install-r7server/single/otkazoustojchivaja-arhitektura-korporativnyj-server-2024-pochtovyj-server-na-astra-linux-1-7-4/
- https://r7-office.ru/downloadserver#retail
- https://nct.r7-office.ru/link/549705e3-5e21-49f1-afc4-57c88ecae674 

Для корректной установки почтового сервера весь архив и сертификаты поместить в директории `/mnt` и распоковать их

Распакуйте архивы CDinstall_2.0.2024.14752_Astra_1.7.4_offline.zip и cddisk.zip
```bash
# cd /mnt
# unzip CDinstall_2.0.2024.14752_Astra_1.7.4_offline.zip
# unzip cddisk.zip
```
Перед установкой почтового сервера, скопируйте crt и key файлы в папку /mnt/CDDiskPack/CDinstall_Astra_1.7.4/sslcert

Устанавливаем виртуальную машину ОС Астра 1.7.4 из образа
```bash
1.7.4-24.04.2023_14.23.iso
```
> При установке операционной системы выберите пункты (во избежание сообщений об отсутствующих зависимостях)
> - **«Средства работы с интернет»** <br>
> - **«Консольные утилиты»** <br>
> - **«Средства удаленного подключения SSH»** 
 
> [!WARNING]
> Для упрощения в работе временно даём разрешение на подключению по ssh для суперадмина root

Открываем терминал меняем пароль на root и даём разрешение на подключение в файле `/etc/ssh/sshd_config`
```bash
$ sudo -i
# sed -i 's/^#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
```
#### Раскомментировать PermitRootLogin и установить значение yes:
```bash
# sed -i 's/^#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
```
##### Перезапустить SSH службу для применения изменений:
######  Для системы с systemd (большинство современных дистрибутивов)
```bash
# systemctl restart sshd
```
##### Проверить, что изменения применились:
```bash
# sshd -T | grep permitrootlogin
```
#### Настраиваем сеть
Настраиваем ``FQDN`` имя первого почтового сервера:
```bash
hostnamectl set-hostname mx1.r16.rosreestr.ru
```
Отключаем ipv6 на всех интерфейсах кроме lo.(не обязательно!) 
> [!TIP]
>Отключение IPv6 настройкой параметров ядра сделано в ОС Astra Linux по умолчанию (см. выше файл /etc/sysctl.d/999-astra.conf), однако при наличии загруженного модуля ядра IPv6 служба NetworkManager по умолчанию сама назначает сетевым интерфейсам адреса IPv6. 
>Независимо от используемой аппаратной платформы для успешной работы серверов (реплик) FreeIPA сетевой интерфейс обратной петли (loopback, lo) должен иметь адрес IPv6.

```bash
nano  /etc/sysctl.d/999-astra.conf
# Astra sysctl config

kernel.sysrq = 0
fs.suid_dumpable = 0
kernel.randomize_va_space = 2
net.ipv4.tcp_timestamps = 0
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 0
```
Применяем настройки
```bash
sysctl --system
или можно так
sysctl -p
```
Отключаем NetworkManager.

Откючаем и забываем, на серверах не должно быть динамического адреса.
```bash
sudo systemctl status NetworkManager //проверяем статус службы NetworkManager
sudo systemctl stop NetworkManager //останавливает службу
sudo systemctl disable NetworkManager //удаляет её из автозагрузки
sudo systemctl mask NetworkManager //останавливает активность службы
astra-noautonet-control disable //контрольный выстрел
```

Настраиваем статический адрес службы ``networking.service`` 

вводим команду: ``nano /etc/network/interfaces``
```bash
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

auto eth0
allow-hotplug eth0
iface eth0 inet static
address 10.113.25.18
netmask 255.255.255.0
gateway 10.113.25.11
```
$${\color{#FF8800}reboot}$$

После перезагрузки проверяем
```bash
root@mx1:~# hostname && hostname -s && hostname -f && hostname -d
mx1.r16.rosreestr.ru
mx1
mx1.r16.rosreestr.ru
r16.rosreestr.ru
root@mx1:~#
```

Открываем репозитории  nano /etc/apt/sources.list

<img width="1278" height="210" alt="image" src="https://github.com/user-attachments/assets/f4b501e2-998f-46d2-9b2f-3dc0dac47e02" />

```bash
# sed -i '/^deb.*cdrom/s/^deb/#deb/' /etc/apt/sources.list
# sed -i '/repository-main/s/^#//' /etc/apt/sources.list
# sed -i '/repository-base/s/^#//' /etc/apt/sources.list
# sed -i '/repository-extended/s/^#//' /etc/apt/sources.list
```

Теперь обновим и установим необходимые для дальнейшей работы пакеты
```bash
# apt update
# apt install open-vm-tools
# apt install dnsutils wget curl
# apt install cabextract
```
Добавим и запустить службу синхронизации времени chrony в автозапуск.
>[!Note]
>Серверная служба chronyd (пакет chrony) Может обеспечивать работу ОС в режиме как сервера точного времени, так и клиента. Является штатной службой времени для использования с контроллерами домена FreeIPA.

```bash
# apt install chrony
# systemctl start chrony
# systemctl enable chrony
```
Добавим Российские NTP сервера и можно указать разрешённую сеть для клиентов.
Вводим ``nano /etc/chrony/chrony.conf`` и добавляем эти строки
```bash
server 0.ru.pool.ntp.org iburst
server 1.ru.pool.ntp.org iburst
server 2.ru.pool.ntp.org iburst
server 3.ru.pool.ntp.org iburst
```

<img width="1276" height="942" alt="image" src="https://github.com/user-attachments/assets/8d7c2ea7-af52-4a7b-83fd-b5b52720c2ec" />

После настройки сервера нужно перезапустить службу: ``# systemctl restart chrony``

Проверим источники времени:``# chronyc -N sources``

Проверим порт. Сервер времени chrony, также как и другие NTP сервера слушает порт udp 123: ``sudo ss -ulpn | grep chronyd``

Можем посмотреть количество активных и не активных источников: ``sudo chronyc activity``

Сделаем перезагрузку и убедимся, что служба запускается автоматически.


Подготовка к установке завершена.

$${\color{#FF8800}reboot}$$

После перезагрузки ещё раз убедимся что всё в порядке, проверяем
```bash
root@mx1:~# hostname && hostname -s && hostname -f && hostname -d
должно показать это
mx1.r16.rosreestr.ru
mx1
mx1.r16.rosreestr.ru
r16.rosreestr.ru
root@mx1:~#
```
>[!Note]
>Теперь все эти настройки повторить на втором почтовом сервере!
>##### Подготовка ПО Астра Линукс (настройка сети, установка обновлений, установка дополнительных программ) на сервере 2



#### 2. Установка GlusterFS и базы данных PostgreSQL

**Схема взаимодействия между почтовыми серверами**

<img width="768" height="426" alt="image" src="https://github.com/user-attachments/assets/96c1e639-fc51-4122-834c-b6fae3ccce34" />

### 2.1 установка GlusterFS и базы данных PostgreSQL $${\color{red}На}$$ $${\color{red}сервере}$$ $${\color{red}№1}$$
##### Установка и настройка glusterfs
Добавьте запись в /etc/hosts:
```bash
127.0.0.1       localhost
first_ip_address  gluster1
second_ip_address gluster2
```
>[!Warning]
> - Рекомендуется использовать запись 127.0.0.1 localhost как стандартную и без использования имени сервера, так как в дальнейшем будут добавлены другие записи для работы почтового сервера.
> - Для корректной установки корпоративного сервера требуется наличие перевода строки в конце файла /etc/hosts.
>- Без использования почтового сервера возможно задать любое имя сервера.

### 2.2 установка GlusterFS и базы данных PostgreSQL $${\color{red}На}$$ $${\color{red}сервере}$$ $${\color{red}№2}$$

Добавьте запись в /etc/hosts:
```bash
127.0.0.1       localhost
first_ip_address  gluster1
second_ip_address gluster2
```
>[!Warning]
> - Рекомендуется использовать запись 127.0.0.1 localhost как стандартную и без использования имени сервера, так как в дальнейшем будут добавлены другие записи для работы почтового сервера.
> - Для корректной установки корпоративного сервера требуется наличие перевода строки в конце файла /etc/hosts.
>- Без использования почтового сервера возможно задать любое имя сервера.

##### На всех нодах установить, запустить и добавить в автозагрузку
```cmd
apt install -y glusterfs-server
systemctl start glusterd.service
systemctl enable glusterd.service
```
Не имеет значения, какой из узлов вы будете использовать, но в следующем примере команда запускается на gluster1:
```cmd
gluster peer probe gluster2
```
Фактически эта команда сообщает gluster1 доверять gluster2 и регистрирует его как часть пула хранения данных.

Если зондирование пройдет успешно, вы получите следующий вывод:
```cmd
peer probe: success
```
Вы можете проверить связь узлов в любое время путем запуска команды:
```cmd
gluster peer status
```
Если вы запустите эту команду из gluster2, вы увидите следующий вывод:
```cmd
Number of Peers: 1
Hostname: gluster1
Uuid: 7ecfa2d1-3394-4f15-a1f5-bba484f2bbef
State: Peer in Cluster (Connected)
```
> [!IMPORTANT]
>- Рекомендуется на время установки/настройки отключить firewalld.

### 2.3 Создание томов
>[!Warning]
>Выполняется **$${\color{red}НА}$$ $${\color{red}ПЕРВОМ}$$ $${\color{red}СЕРВЕРЕ №1}$$**

Для создания тома вы будете использовать команду gluster volume create с таким общим синтаксисом:

##### и для почтового сервера
```cmd
sudo gluster volume create mail_volume replica 2 gluster{1,2}:/mail_volume force
```
##### для корпоративного сервера
```cmd
sudo gluster volume create cddisk-filestorage replica 2 gluster{1,2}:/cddisk-filestorage force
sudo gluster volume create cddisk-searchindex replica 2 gluster{1,2}:/cddisk-searchindex force
sudo gluster volume create ds-data replica 2 gluster{1,2}:/ds-data force
sudo gluster volume create ds-cache replica 2 gluster{1,2}:/ds-cache force
```
Если том был создан успешно, вы увидите следующий вывод:
```cmd
volume create: mail_volume: success: please start the volume to access data
```
На этом этапе ваш том создан, но еще не активирован. Вы можете запустить том и сделать его доступным для использования путем выполнения следующей команды с любого сервера Gluster:

##### для почтового сервера
```cmd
sudo gluster volume start mail_volume
```
##### для корпоративного сервера
```cmd
sudo gluster volume start cddisk-filestorage
sudo gluster volume start cddisk-searchindex
sudo gluster volume start ds-data
sudo gluster volume start ds-cache
```
Вы получите следующий вывод, если том запущен корректно:
```cmd
volume start: mail_volume: success
volume start: cddisk-filestorage: success
volume start: cddisk-searchindex: success
volume start: ds-data: success
volume start: ds-cache: success
```
Затем проверьте, находится ли том в сети. Запустите следующую команду с любого из ваших узлов:
```cmd
sudo gluster volume status
```
В результате вы увидите вывод, аналогичный данному:
```cmd
Status of volume: mail
Gluster process TCP Port RDMA Port Online Pid
------------------------------------------------------------------------------
Brick gluster1:/mail 49152 0 Y 4495
Brick gluster2:/mail 49152 0 Y 20192
Self-heal Daemon on localhost N/A N/A Y 4518
Self-heal Daemon on gluster2 N/A N/A Y 20215
Task Status of Volume mail_volume
------------------------------------------------------------------------------
There are no active volume tasks
```
Создайте каталог и смонтируйте
>[!Warning]
>Инструкция ниже выполняется **$${\color{red}НА}$$ $${\color{red}ВСЕХ}$$ $${\color{red}СЕРВЕРАХ}$$**

##### для почтового сервера
```cmd
mkdir /mail
```
##### для корпоративного сервера
```cmd
mkdir -p /var/r7-office/filestorage
mkdir -p /var/r7-office/searchindex
mkdir -p /var/www/r7-office/Data
mkdir -p /var/lib/r7-office/documentserver/App_Data/cache
```
##### для почтового сервера
```cmd
mount.glusterfs localhost:/mail_volume /mail
```
##### для корпоративного сервера
```cmd
mount.glusterfs localhost:/cddisk-filestorage /var/r7-office/filestorage
mount.glusterfs localhost:/cddisk-searchindex /var/r7-office/searchindex
mount.glusterfs localhost:/ds-data /var/www/r7-office/Data
mount.glusterfs localhost:/ds-cache /var/lib/r7-office/documentserver/App_Data/cache
```
Добавьте в автозагрузку:

##### для почтового сервера 
```cmd
{
echo 'localhost:/mail_volume /mail glusterfs defaults,_netdev,backupvolfile-server=localhost 0 0'
echo 'localhost:/cddisk-filestorage /var/r7-office/filestorage glusterfs defaults,_netdev,backupvolfile-server=localhost 0 0'
echo 'localhost:/cddisk-searchindex /var/r7-office/searchindex glusterfs defaults,_netdev,backupvolfile-server=localhost 0 0'
echo 'localhost:/ds-data /var/www/r7-office/Data glusterfs defaults,_netdev,backupvolfile-server=localhost 0 0'
echo 'localhost:/ds-cache /var/lib/r7-office/documentserver/App_Data/cache glusterfs defaults,_netdev,backupvolfile-server=localhost 0 0'
} | sudo tee -a /etc/fstab
```
Добавьте задание для перезапуска glusterfs, в случае перезагрузки или выключения питания:

>[!Warning]
>Инструкция ниже выполняется **$${\color{red}НА}$$ $${\color{red}ВСЕХ}$$ $${\color{red}СЕРВЕРАХ}$$**

После перезагрузки сервера, могут наблюдаться проблемы с синхронизацией glusterfs. Поэтому данный метод решает эту проблему:
```cmd
echo "@reboot sleep 30 && systemctl restart glusterd.service" | crontab -
```
Проверка монтирования:
```cmd
df -h
mount -a
```
Проверьте корректность синхронизации каталогов между серверами, создавая тестовые файлы или каталоги в монтированных каталогах.

При настройке разрешенных портов рекомендуется проверить все задействованные порты на двух серверах:
```cmd
ss -tulnp | grep gluster
```
>[!Note]
> - Для применения параметров выполните перезапуск серверов.

**На этом этапе два ваших сервера взаимодействуют и готовы к созданию томов хранения друг с другом**

#### 3. Установка и настройка БД.
Установите следующие пакеты на оба сервера:
```cmd
sudo apt update && sudo apt install postgresql -y
```
##### БД
>[!Warning]
> - Инструкция ниже выполняется **$${\color{red}НА}$$ $${\color{red}ВСЕХ}$$ $${\color{red}СЕРВЕРАХ}$$**

Отредактируйте postgresql.conf:
```cmd
sudo nano /etc/postgresql/11/main/postgresql.conf
```
>[!Warning]
> - В зависимости от версии установленной postgresql сервера, путь к конфигурационному файлу может отличаться.

Приведите параметры к виду:
```cmd
listen_addresses = 'localhost,192.168.26.48' # what IP address(es) to listen on;
port = 5432
```
- Где: localhost, 192.168.26.48 — адреса, которые слушает сервис; 5432 — порт, который сервис прослушивает.

В файле postgresql.conf разрешите логическую репликацию. Для этого отредактируйте /etc/postgresql/11/main/postgresql.conf:
```cmd
listen_addresses = 'localhost,ip_srv,ip_srv2'       # Слушать на адресах
port = 5432                         # Задать порт БД
wal_level = replica             # Включить репликацию
archive_mode = on               # Включить архивирование WAL
archive_command = 'cp %p /var/lib/postgresql/11/main/archive/%f'   # Команда для архивирования WAL, в зависимости от версии установленной postgresql сервера, путь к файлу может отличаться
max_wal_senders = 5            # Максимальное количество одновременных подключений репликации
max_replication_slots = 5          # Количество слотов для репликации
hot_standby = on                # Разрешить подключения в режиме hot standby
hot_standby_feedback = on        # Определяет, будет или нет сервер slave сообщать мастеру о запросах, которые он выполняет.
```
- Где: ip_srv1, ip_srv2 — адреса внутренней сети первого и второго почтового сервера.

Настройте аутентификацию пользователей в базе данных. Приведите к следующему виду файл ``/etc/postgresql/11/main/pg_hba.conf``:

##### Разрешить локальные подключения для всех пользователей
```cmd
# "local" is for Unix domain socket connections only
local   all             all                              trust
# IPv4 local connections:
host    all             all             127.0.0.1/32     trust
host    all             all             ip_srv1/32       trust
host    all             all             ip_srv2/32       trust
```
Вместо ``ip_srv1/32 и ip_srv2/32`` укажите IP-адрес двух серверов. Режим trust необходим для установки Корпоративного сервера.

И добавьте строки в конце для возможности репликации БД:

##### Разрешить репликацию с обоих серверов для пользователя replication_user
```cmd
host    replication     replication_user        ip_srv1/32    md5
host    replication     replication_user        ip_srv2/32    md5
```
- Где: ``ip_another_srv/32`` — адрес первого или второго почтового сервера, в зависимости от сервера, где производится настройка.

Выполните перезапуск сервиса БД:
```cmd
sudo systemctl restart postgresql
```
>[!Warning]
> - Инструкция ниже выполняется **$${\color{red}НА}$$ $${\color{red}ПЕРВОМ}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№1}$$**

После базовой настройки базы данных, создаем необходимую структуру в БД, создаем пользователей и настраиваем репликацию:
```cmd
sudo -u postgres psql
```
В консоли psql> выполните следующие команды (вместо паролей password и replication_password, cddisk и ds задайте свои пароли), подтверждая каждую нажатием 
```cmd
Enter
:
```
>[!Warning] Не рекомендуется использовать другие имена для баз данных cddisk и ds.
```cmd
CREATE USER cddisk WITH password 'cddisk';
CREATE USER ds WITH password 'ds';
CREATE DATABASE cddisk OWNER cddisk;
CREATE DATABASE ds OWNER ds;
CREATE DATABASE pagesdb OWNER cddisk;
GRANT ALL privileges ON DATABASE cddisk TO cddisk;
GRANT ALL privileges ON DATABASE ds TO ds;
GRANT ALL privileges ON DATABASE pagesdb TO cddisk;
CREATE USER replication_user WITH REPLICATION LOGIN PASSWORD 'replication_password';
GRANT CONNECT ON DATABASE cddisk TO replication_user;
GRANT CONNECT ON DATABASE ds TO replication_user;
\c cddisk
GRANT USAGE ON SCHEMA public TO replication_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO replication_user;
GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO replication_user;
\c ds
GRANT USAGE ON SCHEMA public TO replication_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO replication_user;
GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO replication_user;
Для выхода из БД
\q
```
>[!Warning]
> - Инструкция ниже выполняется **$${\color{red}НА}$$ $${\color{red}ПЕРВОМ}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№1}$$**

Создайте директорию для архива:

в зависимости от версии установленной postgresql сервера, путь к каталогу может отличаться
```cmd
sudo mkdir -p /var/lib/postgresql/11/main/archive
sudo chown -R postgres:postgres /var/lib/postgresql/11/main/archive
sudo chmod -R 750 /var/lib/postgresql/11/main/archive
```cmd
>[!Warning]
> - Инструкция ниже выполняется **$${\color{red}НА}$$ $${\color{red}ПЕРВОМ}$$ $${\color{red}СЕРВЕРЕ №1}$$**

Перезагрузите службу PostgreSQL для применения изменений:
```cmd
systemctl restart postgresql*
```
##### Настройка репликации БД
>[!Warning]
> - Инструкция ниже выполняется **$${\color{red}НА}$$ $${\color{red}ВТОРОМ}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№2}$$**

Удалите существующую директорию данных:

в зависимости от версии установленной postgresql сервера, путь к каталогу может отличаться
```cmd
rm -rf /var/lib/postgresql/11/main
```
Создайте базовую резервную копию с мастера:

в зависимости от версии установленной postgresql сервера, путь pgdata=/var/lib/postgresql/11/main может отличаться
```cmd
su - postgres -c "pg_basebackup --host=ip_srv1 --username=replication_user --pgdata=/var/lib/postgresql/11/main --wal-method=stream --write-recovery-conf"
```
- Где: ip_srv1 — адрес внутренней сети первого сервера, с master БД.

Перезапустите сервис и проверьте его статус:
```cmd
systemctl restart postgresql*
systemctl status postgresql*
```
#### 4. Установка Корпоративного сервера.

Выполнение установки по инструкции Установка Корпоративный сервер 2024 на ОС Астра Линукс https://support.r7-office.ru/corporate-server2024/install-r7server/single/ustanovka-r7-disk/.

##### Предварительная подготовка

Перейдите и скачайте дистрибутив на сервер № 2.

>[!NOTE]
> - Для корректной установки, разместите архив в директории, отличной от /root, например в /mnt или /tmp.

Нашу настройку двухнодовой архитектуры необходимо начать с установки на втором сервере, чтобы избежать последующих ошибок с серверами.

Перейдите в каталог:
```
cd /mnt
```
Распакуйте архив:
```
unzip CDinstall_*.zip
```
Перейдите в каталог ``CDDiskPack/CDinstall/``:
```
cd CDDiskPack/CDinstall/
```
>[!Warning]
> - Для корректной работы Корпоративного сервера 2024 обязательно требуется настройка HTTPS. Перед установкой скопируйте crt и key файлы в папку sslcert.

Предоставьте права на скрипт установки:
```
chmod +x online_installer.sh
````
Создайте DNS запись для Корпоративного сервера, например:

DNS запись для Корпоративного сервера

Если Offline установка
```
chmod +x offline_installer.sh
```
>[!Warning]
> - Для offline установки требуется установить пакеты в систему и подключить ISO-образ установочного диска операционный системы в папку distr.

>[!TIP]
> - Скачать пакеты можно по данной ссылке https://nct.r7-office.ru/link/549705e3-5e21-49f1-afc4-57c88ecae674.

Архив cddisk.zip содержит необходимые пакеты для Корпоративного сервера 2024.

1. Установить wget;<br>
2. Скачать архив cddisk.zip, распаковать и установить пакеты командой
```
sh install.sh.
```
>[!Warning]
> - В папку ./distr положите ISO-образ установочного диска операционный системы. Файл должен быть с расширением .iso. Данный образ вы можете скачать с официального сайта производителя.

##### 4.1 Установка Корпоративного сервера на сервере 2
>[!Warning]
> - Инструкция ниже выполняется **$${\color{red}НА}$$ $${\color{red}ВТОРОМ}$$ $${\color{red}СЕРВЕРЕ}$$ $${\color{red}№2}$$**

Если установка online

Выполните команду:
```
./online_installer.sh
```
Если установка offline

Убедитесь, что все репозитории отключены, чтобы установка пакетов происходила исключительно из offline архива. <br>Для этого удалите или закомментируйте (добавив символ # в начало строки) все строки в файле /etc/apt/sources.list, а также очистите содержимое папки /etc/apt/sources.list.d.

После этого запустите установку:
```
./offline_installer.sh
```
Выберите Нет, иначе произойдет удаление PostgreSQL:

Диалог установки - выбор Нет для PostgreSQL

**Выберите Нет:**

Диалог установки - повторный выбор Нет

**Выберите Да:**

Диалог установки - выбор Да для продолжения

**Задайте secret. Необходимо ввести секрет (Набор цифр, букв и спецсимволов. Длина от 8 символов) для защищённого доступа Р7-Диска и Сервера документов:**

Диалог установки - ввод секрета

**Укажите пароль к БД ds, ранее созданный в пункте 3.1 (из примера: ds):**

Диалог установки - ввод пароля БД ds

**Выберите Да:**

Диалог установки - подтверждение выбора

**Выберите PostgreSQL:**

Диалог установки - выбор PostgreSQL

**Выберите Нет:**

Диалог установки - отказ от автоматической настройки

**Укажите БД master и IP-адрес текущего первого сервера:**

Диалог установки - указание БД master и IP-адреса

**Укажите по умолчанию порт 5432:**

Диалог установки - указание порта 5432

**Укажите БД cddisk из пункта 3.1 (из примера: cddisk):**

Диалог установки - указание БД cddisk

**Укажите системного пользователя postgres:**

**Укажите пользователя cddisk:**

**Укажите пароль к БД cddisk из пункта 3.1 (из примера: cddisk):**

Диалог установки - ввод пароля БД cddisk

**Укажите пароль к пользователю cddisk из пункта 3.1 (из примера: cddisk):**


Измените на актуальный, если есть Корпоративный сервер 2019 и нажмите ОК:

Диалог установки - настройка совместимости с КС 2019

**Выберите Да:**

Диалог установки - финальное подтверждение

**Необходимо указать домен, в котором у вас созданы записи из пункта подготовки:**

Диалог установки - указание домена

Далее укажите необходимые префиксы для всех модулей.

**Выберите Да (если требуется установка почтового сервера):**

Диалог установки - выбор установки почтового сервера

>[!Warning]
> - Дальнейшие действия нужно выполнять только при установке Корпоративного сервера 2024 с Почтовым сервером, иначе перезагрузите сервер.

**Выберите PostgreSQL:**

Диалог установки почтового сервера - выбор PostgreSQL

**Необходимо указать имя сервера:**

**Укажите IP-адрес сервера:**

Диалог установки почтового сервера - указание IP-адреса

Укажите пароль для пользователя postfix:

Диалог установки почтового сервера - ввод пароля postfix

**Если требуется установка SpamAssassin:**

**Выберите 1**
**Если не требуется установка SpamAssassin:**

**Выберите 2**
Диалог установки почтового сервера - выбор SpamAssassin
**Если требуется установка:**

**Выберите Да**
Если не требуется установка:

**Выберите Нет**

Диалог установки почтового сервера - финальное подтверждение

**После инсталляции в консоли будет предложено сделать TXT-запись:**


Перезапустите сервер.

##### ##### 4.2 Установка Корпоративного сервера на сервере 1
>[!Warning]
> - Инструкция ниже выполняется **$${\color{red}НА}$$ $${\color{red}ПЕРВОМ}$$ $${\color{red}СЕРВЕРЕ №1}$$**

Перед установкой Корпоративного **$${\color{red}сервера}$$ $${\color{red}№1}$$** необходимо пересоздать базу данных, чтобы избежать дублирования информации.
```
DROP DATABASE IF EXISTS cddisk;
```
**Далее мы создадим базу данных заново на мастере из пункта 3**

Скачайте дистрибутив на сервер № 1.

>[!TIP]
> - Для корректной установки, разместите архив в директории, отличной от /root, например в /mnt или /tmp.

Перейдите в каталог:
```
cd /mnt
```
Распакуйте архив:
```
unzip CDinstall_*.zip
```
>[!Warning]
> - Для корректной работы Корпоративного сервера 2024 обязательно требуется настройка HTTPS. Перед установкой скопируйте crt и key файлы в папку sslcert.

Перейдите в каталог CDDiskPack/CDinstall/:
```
cd CDDiskPack/CDinstall/
```
Предоставьте права на скрипт установки:
```cmd
chmod +x online_installer.sh
Если Offline установка
chmod +x offline_installer.sh
```
>[!Warning]
>Для offline установки требуется установить пакеты в систему и подключить ISO-образ установочного диска операционный системы в папку distr.

>[!TIP]
> - Скачать пакеты можно по данной ссылке ↗.

Архив cddisk.zip содержит необходимые пакеты для Корпоративного сервера 2024.

1. Установить wget;<br>
2. Скачать архив cddisk.zip, распаковать и установить пакеты командой
```cmd
sh install.sh.
```
>[!Warning]
> - В папку ./distr положите ISO-образ установочного диска операционный системы. Файл должен быть с расширением .iso. Данный образ вы можете скачать с официального сайта производителя.

##### Запуск установки
Если установка online

Выполните команду:
```cmd
./online_installer.sh
```
Если установка offline

Убедитесь, что все репозитории отключены, чтобы установка пакетов происходила исключительно из offline архива. <br>Для этого удалите или закомментируйте (добавив символ # в начало строки) все строки в файле /etc/apt/sources.list, а также очистите содержимое папки /etc/apt/sources.list.d.

После этого запустите установку:
```cmd
./offline_installer.sh
```
**Выберите Нет:**

Диалог установки второго сервера - выбор Нет

**Выберите Нет:**

Диалог установки второго сервера - повторный выбор Нет

**Выберите Да:**

Диалог установки второго сервера - выбор Да

**Укажите такой же secret как для второго сервера:**

Диалог установки второго сервера - ввод secret

**Укажите пароль к БД ds из пункта 3.1 (из примера ds):**

Диалог установки второго сервера - ввод пароля БД ds

**Выберите Да:**

Диалог установки второго сервера - подтверждение

**Выберите PostgreSQL:**

Диалог установки второго сервера - выбор PostgreSQL

**Выберите Нет:**

Диалог установки второго сервера - отказ от автоконфигурации

**Укажите IP-адрес первого сервера master:**

Диалог установки второго сервера - указание IP master

**Укажите порт 5432:**

Диалог установки второго сервера - указание порта

**Укажите имя БД cddisk:**


**Укажите пользователя postgres:**


**Укажите пользователя cddisk для БД cddisk:**


**Укажите БД cddisk из пункта 3.1 (из примера: cddisk):**

Диалог установки второго сервера - указание БД cddisk

**Укажите пароль к БД cddisk из пункта 3.1 (из примера: cddisk):**

Диалог установки второго сервера - ввод пароля cddisk

**Укажите пароль от пользователя cddisk из пункта 3.1 (из примера: cddisk):**

Измените на актуальный, если есть Корпоративный сервер 2019 и нажмите ОК:

Диалог установки второго сервера - настройка совместимости

**Выберите Да:**

Диалог установки второго сервера - финальное подтверждение

**Необходимо указать домен, в котором у вас созданы записи из пункта подготовки:**

Диалог установки второго сервера - указание домена

Далее укажите необходимые префиксы для всех модулей, одинаковые со вторым сервером.

**Выберите Да (если требуется установка почтового сервера):**

Диалог установки второго сервера - выбор почтового сервера

>[!Warning]
> - Дальнейшие действия нужно выполнять только при установке Корпоративного сервера 2024 с Почтовым сервером, иначе перезагрузите сервер.

**Выберите PostgreSQL:**

Диалог установки почтового сервера на втором сервере

**Необходимо указать имя для первого сервера:**

**Укажите IP-адрес сервера:**

Диалог установки почтового сервера на втором сервере - IP-адрес

**Укажите пароль для пользователя postfix (нужно указать такой же пароль, как на втором сервере):**

Диалог установки почтового сервера на втором сервере - пароль postfix

**Если требуется установка SpamAssassin (выберите тот же вариант, который указали при установке второго сервера):**

**Выберите 1**

**Если не требуется установка SpamAssassin:**

**Выберите 2**

Диалог установки почтового сервера на втором сервере - SpamAssassin

**Если требуется установка (выберите тот же вариант, которые указали при установке второго сервера):**

**Выберите Да**

**Если не требуется установка:**

**Выберите Нет**

Диалог установки почтового сервера на втором сервере - финальный выбор

**После инсталляции в консоли будет предложено сделать TXT запись:**

Установка Р7-Диск на ОС Astra Linux и Debian - TXT запись

Перезапустите сервер.

#### 4.3 Дополнительная настройку Nginx и Сервер документов
Выведите значение параметра secure_link_secret на первом сервере:
```cmd
grep -rn "set \$secure_link_secret" /etc/r7-office/documentserver/nginx/ds.conf
```
Пример вывода:

13: set $secure_link_secret kCj7RMAAYCNtOh6KiGin;
Для второго сервера:
```cmd
sudo sed -i "s/set \$secure_link_secret [^;]*/set \$secure_link_secret НОВОЕ_ЗНАЧЕНИЕ/" $(grep -rl "set \$secure_link_secret" /etc/r7-office/documentserver/)
sudo sed -i -E "s/\"secretString\": .+/\"secretString\": \"НОВОЕ_ЗНАЧЕНИЕ\"/" $(grep -rl "secretString" /etc/r7-office/documentserver/)

Где, замените НОВОЕ_ЗНАЧЕНИЕ на необходимый параметр c вывода предыдущей команды (пример, kCj7RMAAYCNtOh6KiGin).
```

Измените в /etc/r7-office/documentserver/local.json строку:
```cmd
"dbHost": "localhost"
```
Где потребуется заменить localhost на адрес текущего мастера (первого сервера), из примера 192.168.27.135.

Выполните команды по перезапуску Nginx и Сервера документов:
```
systemctl restart nginx ds-converter.service ds-docservice.service ds-metrics.service
````
#### 4.4 Настройка подключения почтового сервера (*опционально)

Перейдите в https://admin.test2.s7-office.site/ Организации — Выберите организацию, в которую добавлены пользователи — Почтовые серверы:

Настройка подключения почтового сервера - интерфейс

**Укажите ранее добавленные данные по почтовому серверу:**

Настройка подключения почтового сервера - данные сервера

Скопируйте папку /home/mail_cddisk/.ssh из первого сервера во второй сервер.

Выполните на втором сервере:
```cmd
chown -R mail_cddisk:mail_cddisk /home/mail_cddisk/.ssh
```
#### 4.7 Управление переключением БД при неработоспособности первого сервера
##### Создайте скрипт управления
>[!Warning]
> - Готовый скрипт можно скачать по данной ссылке https://download.r7-office.ru/mailserver/scripts/db-switch-cs24/change.sh

Укажите необходимые константы в начале скрипта. Потребуется указать необходимые параметры, что является master (первый сервер) и slave (второй сервер).

##### Константы для подключения к БД
- MASTER_IP="192.168.27.186" — укажите адрес master БД;
- MASTER_MAIL_FQDN="mx1.stend12.s7-office.site" — укажите FQDN имя почтового сервера на master;
- SLAVE_IP="192.168.26.253" — укажите адрес replica БД;
- REPLICATION_USER="replication_user" — укажите пользователя для репликации;
- REPLICATION_PASS="replication_password" — пароль от пользователя для репликации;
- LOG_FILE="/var/log/switch_postgres.log" — расположение файла логирования скрипта;
- PG_DATA="/var/lib/postgresql/11/main" — расположение каталога с базой;
- PG_BIN="/usr/lib/postgresql/11/bin" — расположение исполняемых файлов PostgreSQL.

##### Константы для cddisk (appsettings.json)
- CDDISK_DB_NAME="cddisk" — не рекомендуется изменять;
- CDDISK_DB_USER="cddisk" — укажите пользователя Корпоративного сервера 2024;
- CDDISK_DB_PASS="cddisk" — укажите пароль для пользователя Корпоративного сервера 2024;
- CDDISK_DB_PORT="5432" — укажите порт БД.

##### Константы для documentserver (local.json)
- DS_DB_NAME="ds" — не рекомендуется изменять;
- DS_DB_USER="ds" — укажите пользователя ДС;
- DS_DB_PASS="ds" — укажите пароль для пользователя ДС;
- DS_DB_PORT="5432" — укажите порт БД.

##### Константы для почтового сервера (postfix, dovecot)
- MAIL_DB_NAME="postfix" — не рекомендуется изменять;
- MAIL_DB_USER="postfix" — укажите пользователя Postfix;
- MAIL_DB_PASS="postfix" — укажите пароль пользователя Postfix;
- MAIL_DB_PORT="5432" — укажите порт БД.

Описание пунктов в скрипте:

1. Установка параметров master — устанавливает параметры master для сервера используемого основным (меняет конфигурации приложений на использование БД master) и создает в том же каталоге резервную копию изменяемых файлов;<br>
2. Установка параметров slave — устанавливает параметры slave для сервера используемым запасным (меняет конфигурации приложений на использование БД master и включение репликации на этом сервере) и создает в том же каталоге резервную копию изменяемых файлов;<br>
3. Показать текущие конфиги — показывает текущие параметры приложений;<br>
4. Проверка подключения с новыми параметрами — проверяет доступ для приложений с заданными константами по подключению к master;<br>
5. Восстановить конфигурации из .bak — при ранее измененных конфигураций приложений может восстановить резервные копии файлов из формата .bak;<br>
6. Перезапустить сервисы приложений — перезапускает сервисы приложений;<br>
7. Показать текущий статус сервера — указывает состояние БД на текущем сервере;<br>
8. Остановка сервисов корпоративного сервера (холодный резерв) — останавливает сервисы корпоративного сервера для режима «холодный резерв».

##### 4.7.1 Настройка второго сервера
Укажите в скрипте текущее представление серверов (master и slave) в константах скрипта (и проверьте другие параметры с корректными данными) и запустите скрипт на втором сервере (slave) пункт меню «Установка параметров slave».

##### 4.7.2 Проверка работы серверов
Для проверки потребуется переключать в DNS А запись ведущая на первый сервер. <br>Перейдите по адресу ``https://admin.test2.s7-office.site``, убедитесь что используется корректная адресация на первый адрес Корпоративного сервера 2024 (используйте команду ping) и используйте предустановленный логин\пароль superadmin. <br>Создайте пользователя и проверьте редактирование файлов — корректное сохранение файлов и повторное открытие файлов.

Далее переключите А запись на второй сервер и так же проверьте его работу.

В DNS используйте установленную текущую ноду как master. Запустите скрипт управления БД и проверьте текущие статусы серверов.

>[!Warning]
> - Настоятельно рекомендуется отработать поэтапное переключение из slave в master на втором сервере в случае ошибок на первом сервере.

##### 5. Настройка LDAP

###### подключение по LDAP на почтовом сервере

<img width="1517" height="636" alt="image" src="https://github.com/user-attachments/assets/b60fb34c-b21c-44aa-9e5c-6f273d9f73b5" />

<img width="1317" height="1058" alt="image" src="https://github.com/user-attachments/assets/bb99b7c7-122c-4b2e-a331-ad600c422c6f" />

<img width="1285" height="1218" alt="image" src="https://github.com/user-attachments/assets/69b192a7-6ecd-44c6-a69e-5db97da50a97" />

<img width="1451" height="1224" alt="image" src="https://github.com/user-attachments/assets/5d36d1a8-eada-412a-acb8-203f563a09c5" />

###### миграция пользователей из AD

<img width="1607" height="1171" alt="image" src="https://github.com/user-attachments/assets/3c830d97-0546-47ed-822f-a562a684aa38" />

###### настройка DNS записей на сервере ALDPRO (настройка почтовых протоколов)

###### проверка работы почтового адреса (хождение внутренней почты) на самом сервере Р7


#### 10. Резервное копирование и восстановление
Для проведения резервирования и восстановления необходимо использовать скрипты из статьи Резервное копирование/восстановление Корпоративный сервер 2024. ↗

Перед использованием скрипта создания бекапа добавьте каталог mail, приведите строку к виду:

#### Создание архива с бэкапом
```cmd
tar cf "$backup_dir/cddisk-${backup_date}.tar.bz2" --selinux --use-compress-prog="lbzip2 -k -n$num_cores" /opt/r7-office $supervisor_dir /etc/r7-office /var/r7-office /var/www/r7-office "$backup_dir/cddisk_db.tar.gz /mail"
```
При восстановлении на мастер ноде рекомендуется остановить службу:
```
systemctl stop glusterfs
```
И после завершения восстановления включить:
```
systemctl start glusterfs
```
При восстановлении резервной ноды нет необходимости выполнения восстановления, так как скрипт позволяет назначить вторую ноду репликой первой для БД и автоматическую синхронизацию каталогов производится средствами glusterfs.






























